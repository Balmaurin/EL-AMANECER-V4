name: ðŸ“š Automated Documentation

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**/*.py'
      - '**/*.ts'
      - '**/*.tsx'
      - '**/*.md'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**/*.py'
      - '**/*.ts'
      - '**/*.tsx'
      - '**/*.md'
  schedule:
    # Ejecutar cada lunes a las 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Forzar actualizaciÃ³n completa de documentaciÃ³n'
        required: false
        default: 'false'

jobs:
  generate-docs:
    name: Generate Live Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Install documentation tools
        run: |
          # Instalar herramientas necesarias para documentaciÃ³n
          pip install ast  # Para anÃ¡lisis de cÃ³digo
          pip install pyyaml  # Para configuraciÃ³n
          pip install markdown  # Para procesamiento de markdown

      - name: Generate Python documentation
        run: |
          echo "ðŸ” Analyzing Python codebase..."
          python -c "
          from tools.documentation.ai_doc_generator import generate_docs
          import asyncio
          import os

          async def run_generation():
              try:
                  result = await generate_docs(
                      codebase_path='.',
                      output_path='./docs/generated/python'
                  )
                  print(f'âœ… Generated documentation for {result[\"stats\"][\"files_processed\"]} Python files')
                  return True
              except Exception as e:
                  print(f'âŒ Error generating docs: {e}')
                  return False

          success = asyncio.run(run_generation())
          exit(0 if success else 1)
          "

      - name: Generate TypeScript/React documentation
        run: |
          echo "ðŸ” Analyzing TypeScript/React codebase..."
          # Crear script simple para analizar archivos TS/TSX
          python -c "
          import os
          import re
          from pathlib import Path

          def analyze_typescript_file(file_path):
              try:
                  with open(file_path, 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  # Extraer informaciÃ³n bÃ¡sica
                  functions = len(re.findall(r'(?:export\s+)?(?:async\s+)?function\s+\w+', content))
                  classes = len(re.findall(r'(?:export\s+)?class\s+\w+', content))
                  interfaces = len(re.findall(r'(?:export\s+)?interface\s+\w+', content))
                  components = len(re.findall(r'(?:export\s+)?(?:const|function)\s+\w+\s*:\s*React\.FC', content))
                  
                  return {
                      'file': os.path.basename(file_path),
                      'functions': functions,
                      'classes': classes,
                      'interfaces': interfaces,
                      'components': components,
                      'lines': len(content.split('\n'))
                  }
              except Exception as e:
                  return {'file': os.path.basename(file_path), 'error': str(e)}

          # Analizar archivos TypeScript
          ts_files = []
          for root, dirs, files in os.walk('Frontend'):
              for file in files:
                  if file.endswith(('.ts', '.tsx')):
                      file_path = os.path.join(root, file)
                      analysis = analyze_typescript_file(file_path)
                      ts_files.append(analysis)

          # Generar documentaciÃ³n
          output_dir = Path('./docs/generated/typescript')
          output_dir.mkdir(parents=True, exist_ok=True)

          with open(output_dir / 'README.md', 'w', encoding='utf-8') as f:
              f.write('# ðŸ“± Frontend Documentation\\n\\n')
              f.write('## ðŸ“Š TypeScript/React Analysis\\n\\n')
              f.write(f'- **Total files analyzed**: {len(ts_files)}\\n')
              
              total_functions = sum(f.get('functions', 0) for f in ts_files)
              total_classes = sum(f.get('classes', 0) for f in ts_files)
              total_interfaces = sum(f.get('interfaces', 0) for f in ts_files)
              total_components = sum(f.get('components', 0) for f in ts_files)
              
              f.write(f'- **Functions**: {total_functions}\\n')
              f.write(f'- **Classes**: {total_classes}\\n')
              f.write(f'- **Interfaces**: {total_interfaces}\\n')
              f.write(f'- **React Components**: {total_components}\\n\\n')
              
              f.write('## ðŸ“ Files\\n\\n')
              for file_info in ts_files:
                  if 'error' not in file_info:
                      f.write(f'- **{file_info[\"file\"]}**: {file_info[\"functions\"]} functions, {file_info[\"classes\"]} classes, {file_info[\"components\"]} components\\n')
              
              f.write('\\n---\\n*Generated automatically*\\n')

          print(f'âœ… Generated TypeScript documentation for {len(ts_files)} files')
          "

      - name: Update main documentation index
        run: |
          echo "ðŸ“ Updating main documentation index..."

          # Crear directorio si no existe
          mkdir -p ./docs/generated

          # Generar Ã­ndice principal
          cat > ./docs/generated/README.md << EOF
          # ðŸ“š Sheily AI - DocumentaciÃ³n Generada AutomÃ¡ticamente

          Esta documentaciÃ³n se genera automÃ¡ticamente desde el cÃ³digo fuente usando anÃ¡lisis inteligente.

          ## ðŸ“ Estructura

          ### ðŸ Backend (Python)
          - [DocumentaciÃ³n Python](./python/README.md)
          - AnÃ¡lisis de mÃ³dulos, funciones y clases
          - Dependencias y arquitectura

          ### ðŸŽ¨ Frontend (TypeScript/React)
          - [DocumentaciÃ³n Frontend](./typescript/README.md)
          - AnÃ¡lisis de componentes y tipos
          - Estructura de la aplicaciÃ³n

          ## ðŸ”„ GeneraciÃ³n AutomÃ¡tica

          Esta documentaciÃ³n se actualiza automÃ¡ticamente cuando:
          - Se modifican archivos Python/TypeScript
          - Se hace push a main/develop
          - Se ejecuta manualmente
          - Cada lunes a las 9 AM UTC

          ## ðŸ“Š EstadÃ­sticas del Proyecto

          *Las estadÃ­sticas se generan durante el proceso de documentaciÃ³n.*

          ## ðŸš€ Uso

          \`\`\`bash
          # Generar documentaciÃ³n manualmente
          python -c "
          from tools.documentation.ai_doc_generator import generate_docs
          import asyncio
          result = asyncio.run(generate_docs('.', './docs/generated'))
          print(f'DocumentaciÃ³n generada para {result[\"stats\"][\"files_processed\"]} archivos')
          "
          \`\`\`

          ---

          *Ãšltima actualizaciÃ³n: \$(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          *Generado por: GitHub Actions CI/CD*
          EOF

      - name: Commit and push documentation
        run: |
          echo "ðŸ’¾ Committing generated documentation..."

          # Configurar git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Verificar si hay cambios
          if git diff --quiet ./docs/generated/; then
            echo "â„¹ï¸ No changes in documentation"
          else
            echo "ðŸ“ Committing documentation changes..."
            git add ./docs/generated/
            git commit -m "ðŸ“š Auto-update documentation - Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" || echo "No changes to commit"
          fi

      - name: Create documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: generated-documentation
          path: ./docs/generated/
          retention-days: 30

      - name: Documentation summary
        run: |
          echo "ðŸ“Š Documentation Generation Summary"
          echo "=================================="
          echo "âœ… Python analysis completed"
          echo "âœ… TypeScript analysis completed"
          echo "âœ… Documentation committed to repository"
          echo "âœ… Artifact created for download"
          echo ""
          echo "ðŸ“ Generated files:"
          find ./docs/generated -type f -name "*.md" | head -10

  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest
    needs: generate-docs

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check documentation completeness
        run: |
          echo "ðŸ” Validating documentation completeness..."

          # Verificar que se generaron archivos
          if [ ! -d "./docs/generated" ]; then
            echo "âŒ Documentation directory not found"
            exit 1
          fi

          # Contar archivos generados
          md_files=$(find ./docs/generated -name "*.md" | wc -l)
          echo "ðŸ“„ Generated ${md_files} documentation files"

          if [ "$md_files" -lt 2 ]; then
            echo "âŒ Insufficient documentation files generated"
            exit 1
          fi

          echo "âœ… Documentation validation passed"

      - name: Check for broken links
        run: |
          echo "ðŸ”— Checking for broken internal links..."

          # Verificar enlaces internos en archivos markdown
          find ./docs/generated -name "*.md" -exec grep -l "\[.*\](\./" {} \; | while read file; do
            echo "Checking links in $file"
            # AquÃ­ irÃ­a lÃ³gica mÃ¡s compleja para verificar enlaces
          done

          echo "âœ… Link validation completed"

  notify:
    name: Notify Documentation Update
    runs-on: ubuntu-latest
    needs: [generate-docs, validate-docs]
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Send notification
        run: |
          echo "ðŸ“¢ Documentation updated successfully!"
          echo "View generated docs at: ./docs/generated/"
          echo "Committed to branch: ${{ github.ref_name }}"

          # AquÃ­ se podrÃ­a aÃ±adir integraciÃ³n con Slack, Discord, etc.
          # para notificar sobre actualizaciones de documentaciÃ³n
