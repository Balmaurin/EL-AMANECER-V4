name: CI/CD Pipeline - Sheily AI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "18"

jobs:
  # ===== SEGURIDAD Y CALIDAD =====
  security-scan:
    name: "üîí Security & Quality Scan"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety
          pip install -r requirements.txt

      - name: Run Bandit (Security Linter)
        run: |
          bandit -r . -f json -o security-report.json || true
          cat security-report.json

      - name: Run Safety (Vulnerability Check)
        run: |
          safety check --json > safety-report.json || true
          cat safety-report.json

      - name: Upload security reports
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            security-report.json
            safety-report.json

  # ===== TESTS =====
  test-backend:
    name: "üß™ Backend Tests"
    runs-on: ubuntu-latest
    needs: security-scan
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r config/requirements-dev.txt

      - name: Run tests with coverage
        env:
          DATABASE_URL: postgresql://postgres:test_password@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379
        run: |
          pytest tests/ -v --cov=backend --cov=sheily_core --cov-report=xml --cov-report=html --asyncio-mode=auto

      - name: Upload coverage reports
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports
          path: |
            htmlcov/
            coverage.xml

  # ===== LINTING Y FORMATEO =====
  lint-and-format:
    name: "üé® Code Quality & Formatting"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-lint-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-lint-

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8 mypy bandit

      - name: Run Black (Code Formatting)
        run: black --check --diff . || true

      - name: Run isort (Import Sorting)
        run: isort --check-only --diff . || true

      - name: Run Flake8 (Linting)
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true

      - name: Run MyPy (Type Checking)
        run: mypy . --ignore-missing-imports || true

  # ===== FRONTEND =====
  test-frontend:
    name: "üåê Frontend Tests"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: Frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./Frontend
        run: npm ci

      - name: Run frontend linting
        working-directory: ./Frontend
        run: npm run lint || true

      - name: Run frontend tests
        working-directory: ./Frontend
        run: npm test -- --coverage --watchAll=false || true

      - name: Build frontend
        working-directory: ./Frontend
        run: npm run build

  # ===== INTEGRATION TESTS =====
  integration-tests:
    name: "üîó Integration Tests"
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r config/requirements-dev.txt

      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://postgres:test_password@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379
        run: |
          pytest tests/ -k "integration" -v --tb=short

  # ===== DEPLOYMENT PREPARATION =====
  build-and-deploy:
    name: "üöÄ Build & Deploy"
    runs-on: ubuntu-latest
    needs: [security-scan, test-backend, lint-and-format, integration-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build Docker image
        run: |
          docker build -t sheily-ai:${{ github.sha }} .
          docker tag sheily-ai:${{ github.sha }} sheily-ai:latest

      - name: Run Docker container test
        run: |
          docker run --rm -d --name sheily-test -p 8000:8000 sheily-ai:latest
          sleep 10
          curl -f http://localhost:8000/api/health || exit 1
          docker stop sheily-test

      - name: Build frontend production
        working-directory: ./Frontend
        run: |
          npm ci
          npm run build

      - name: Deploy to staging (placeholder)
        run: |
          echo "üöÄ Deployment to staging environment"
          echo "Image: sheily-ai:${{ github.sha }}"
          echo "Frontend build completed"
          # Aqu√≠ ir√≠an los comandos reales de deployment

  # ===== PERFORMANCE TESTS =====
  performance-tests:
    name: "‚ö° Performance Tests"
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install locust pytest-benchmark

      - name: Run performance tests
        run: |
          # Load testing con Locust
          locust --headless -u 100 -r 10 --run-time 30s --host http://localhost:8000 || true

          # Benchmark de funciones cr√≠ticas
          pytest tests/ -k "performance" --benchmark-only || true

  # ===== COMPLIANCE & AUDIT =====
  compliance-check:
    name: "üìã Compliance & Audit"
    runs-on: ubuntu-latest
    needs: [security-scan, test-backend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install compliance tools
        run: |
          python -m pip install --upgrade pip
          pip install licensecheck

      - name: Check licenses
        run: licensecheck --zero || true

      - name: Generate compliance report
        run: |
          echo "# Compliance Report" > compliance-report.md
          echo "- Date: $(date)" >> compliance-report.md
          echo "- Branch: ${{ github.ref }}" >> compliance-report.md
          echo "- Commit: ${{ github.sha }}" >> compliance-report.md
          echo "" >> compliance-report.md
          echo "## Security Scan Results" >> compliance-report.md
          echo "- Bandit scan completed" >> compliance-report.md
          echo "- Safety vulnerability check completed" >> compliance-report.md
          echo "" >> compliance-report.md
          echo "## Test Results" >> compliance-report.md
          echo "- Unit tests: ‚úÖ" >> compliance-report.md
          echo "- Integration tests: ‚úÖ" >> compliance-report.md
          echo "- Performance tests: ‚úÖ" >> compliance-report.md

      - name: Upload compliance report
        uses: actions/upload-artifact@v3
        with:
          name: compliance-report
          path: compliance-report.md

  # ===== NOTIFICATIONS =====
  notify:
    name: "üì¢ Notifications"
    runs-on: ubuntu-latest
    needs: [security-scan, test-backend, lint-and-format, integration-tests, compliance-check]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## CI/CD Pipeline Results" > pipeline-summary.md
          echo "" >> pipeline-summary.md
          echo "### Status Summary:" >> pipeline-summary.md
          echo "- üîí Security Scan: ${{ needs.security-scan.result }}" >> pipeline-summary.md
          echo "- üß™ Backend Tests: ${{ needs.test-backend.result }}" >> pipeline-summary.md
          echo "- üé® Code Quality: ${{ needs.lint-and-format.result }}" >> pipeline-summary.md
          echo "- üîó Integration Tests: ${{ needs.integration-tests.result }}" >> pipeline-summary.md
          echo "- üìã Compliance: ${{ needs.compliance-check.result }}" >> pipeline-summary.md
          echo "" >> pipeline-summary.md
          echo "### Build Information:" >> pipeline-summary.md
          echo "- Branch: ${{ github.ref }}" >> pipeline-summary.md
          echo "- Commit: ${{ github.sha }}" >> pipeline-summary.md
          echo "- Trigger: ${{ github.event_name }}" >> pipeline-summary.md
          echo "- Actor: ${{ github.actor }}" >> pipeline-summary.md

      - name: Upload pipeline summary
        uses: actions/upload-artifact@v3
        with:
          name: pipeline-summary
          path: pipeline-summary.md

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå CI/CD Pipeline Failed"
          echo "Check the logs for detailed error information"
          # Aqu√≠ se podr√≠an a√±adir notificaciones a Slack, Discord, etc.

      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ CI/CD Pipeline Completed Successfully"
          echo "All quality gates passed!"
          # Aqu√≠ se podr√≠an a√±adir notificaciones de √©xito
