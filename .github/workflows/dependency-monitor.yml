name: Security Dependencies Monitor

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual trigger

jobs:
  monitor-dependencies:
    name: Monitor FastAPI/Starlette Security Updates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Run security update monitor
        id: monitor
        continue-on-error: true
        run: |
          python scripts/monitor_security_updates.py > monitor_output.txt 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT
          cat monitor_output.txt
      
      - name: Upload monitor report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-monitor-report
          path: |
            monitor_output.txt
            deployment_reports/dependency_check_*.json
          retention-days: 90
      
      - name: Check if update available
        id: check_update
        run: |
          if [ -f "deployment_reports/dependency_check_"*.json ]; then
            LATEST_REPORT=$(ls -t deployment_reports/dependency_check_*.json | head -1)
            ACTION_REQUIRED=$(cat "$LATEST_REPORT" | grep -o '"action_required": *[^,}]*' | cut -d':' -f2 | tr -d ' ')
            echo "action_required=$ACTION_REQUIRED" >> $GITHUB_OUTPUT
          else
            echo "action_required=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create issue if update available
        if: steps.check_update.outputs.action_required == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');
            const reports = fs.readdirSync('deployment_reports')
              .filter(f => f.startsWith('dependency_check_'))
              .sort()
              .reverse();
            
            if (reports.length === 0) return;
            
            const latestReport = JSON.parse(
              fs.readFileSync(`deployment_reports/${reports[0]}`, 'utf8')
            );
            
            const title = 'ðŸš¨ Security Update Available: FastAPI supports Starlette 0.50.0!';
            const body = '## FastAPI Security Update Available\n\n' +
              '**Timestamp:** ' + latestReport.timestamp + '\n\n' +
              '### Update Details\n' +
              '- Current FastAPI: ' + latestReport.fastapi.current + '\n' +
              '- Latest FastAPI: ' + latestReport.fastapi.latest + '\n' +
              '- Current Starlette: ' + latestReport.starlette.current + ' (vulnerable)\n' +
              '- Secure Starlette: ' + latestReport.starlette.secure_version + '\n' +
              '- Starlette 0.50.0 Support: âœ… YES\n\n' +
              '### Action Required\n\n' +
              '1. Update dependencies in all requirement files\n' +
              '2. Run tests: pytest centralized_tests/ -v\n' +
              '3. Verify security fixes\n' +
              '4. Deploy to staging first\n\n' +
              '### Vulnerabilities Fixed\n' +
              'This update will resolve 6 Dependabot alerts:\n' +
              '- #29, #31, #33: O(nÂ²) DoS via Range header (High)\n' +
              '- #28, #30, #32: DoS in multipart forms (Moderate)\n\n' +
              '### References\n' +
              '- KNOWN_VULNERABILITIES.md\n' +
              '- SECURITY_FIXES.md\n' +
              '- Starlette 0.50.0 Release Notes\n\n' +
              '*This issue was automatically created by the Security Dependencies Monitor workflow.*';
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dependencies'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('FastAPI supports Starlette 0.50.0')
            );
            
            if (existingIssue) {
              console.log('Issue already exists:', existingIssue.number);
              const updateBody = 'Update check performed on ' + latestReport.timestamp;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: updateBody
              });
            } else {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'dependencies', 'enhancement']
              });
              console.log('Created issue:', issue.data.number);
            }
      
      - name: Post summary
        if: always()
        run: |
          echo "## Security Dependencies Monitor Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "monitor_output.txt" ]; then
            echo "### Monitor Output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 monitor_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_update.outputs.action_required }}" = "true" ]; then
            echo "ðŸš¨ **ACTION REQUIRED**: FastAPI update available with Starlette 0.50.0 support!" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No updates available yet. Continuing to monitor." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next check:** $(date -d 'next monday 9:00' +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
