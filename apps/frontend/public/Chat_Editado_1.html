<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHEILY AI - Conversational Intelligence</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        :root {
            --bg: #030308;
            --bg-secondary: #0a0b14;
            --fg: #e8f0fc;
            --muted: #8590a8;
            --accent: #00f0ff;
            --accent-secondary: #7cf7d4;
            --accent-glow: rgba(0, 240, 255, 0.3);
            --card: #0f1018;
            --card-border: #14161f;
            --glass: rgba(10, 11, 20, 0.7);
            --ease: cubic-bezier(0.16, 1, 0.3, 1);
            --sidebar-width: 280px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--fg);
        }

        /* ============================================
           LAYOUT PRINCIPAL: SIDEBAR + MAIN
        ============================================ */
        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* ============================================
           SIDEBAR (Historial de Conversaciones)
        ============================================ */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg) 100%);
            border-right: 1px solid var(--card-border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s var(--ease);
            z-index: 100;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--card-border);
        }

        .sidebar-logo {
            font-size: 20px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-pulse {
            width: 10px;
            height: 10px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            border-radius: 50%;
            box-shadow: 0 0 20px var(--accent-glow);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            color: #000;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s var(--ease);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px var(--accent-glow);
        }

        .new-chat-btn:active {
            transform: translateY(0);
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .chat-history::-webkit-scrollbar {
            width: 6px;
        }

        .chat-history::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-history::-webkit-scrollbar-thumb {
            background: var(--card-border);
            border-radius: 10px;
        }

        .chat-history::-webkit-scrollbar-thumb:hover {
            background: var(--muted);
        }

        .history-section {
            margin-bottom: 24px;
        }

        .history-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            padding: 0 12px 8px;
        }

        .history-item {
            padding: 12px 16px;
            margin: 4px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s var(--ease);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .history-item:hover {
            background: rgba(20, 22, 31, 0.6);
            border-color: var(--card-border);
        }

        .history-item.active {
            background: linear-gradient(135deg, rgba(0, 240, 255, 0.15), rgba(124, 247, 212, 0.1));
            border-color: var(--accent);
        }

        .history-item-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--fg);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item-preview {
            font-size: 12px;
            color: var(--muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item-time {
            font-size: 11px;
            color: var(--muted);
            margin-top: 4px;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--card-border);
        }

        .token-display {
            background: rgba(0, 240, 255, 0.1);
            border: 1px solid rgba(0, 240, 255, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .token-label {
            font-size: 12px;
            color: var(--muted);
        }

        .token-count {
            font-size: 20px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ============================================
           MAIN CONTENT AREA
        ============================================ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /* Contin√∫a en PARTE 2... */
        /* ============================================
           MARKDOWN STYLES
        ============================================ */
        .message-bubble h1,
        .message-bubble h2,
        .message-bubble h3 {
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--fg);
        }

        .message-bubble h1 {
            font-size: 1.4em;
        }

        .message-bubble h2 {
            font-size: 1.2em;
        }

        .message-bubble h3 {
            font-size: 1.1em;
        }

        .message-bubble p {
            margin-bottom: 12px;
        }

        .message-bubble p:last-child {
            margin-bottom: 0;
        }

        .message-bubble ul,
        .message-bubble ol {
            margin-bottom: 12px;
            padding-left: 24px;
        }

        .message-bubble li {
            margin-bottom: 4px;
        }

        .message-bubble strong {
            color: var(--accent-secondary);
            font-weight: 700;
        }

        .message-bubble code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: var(--accent);
        }

        .message-bubble pre {
            background: rgba(0, 0, 0, 0.5);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
            border: 1px solid var(--card-border);
        }

        .message-bubble pre code {
            background: transparent;
            padding: 0;
            color: var(--fg);
        }

        /* SIDEBAR NAV */
        .sidebar-nav {
            padding: 10px 16px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border-bottom: 1px solid var(--card-border);
            margin-bottom: 10px;
            flex: 1;
            /* Take available space */
            overflow-y: auto;
        }

        .nav-item {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--muted);
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s var(--ease);
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--fg);
        }

        .nav-item.active {
            background: rgba(0, 240, 255, 0.1);
            color: var(--accent);
            font-weight: 600;
        }

        .nav-icon {
            font-size: 16px;
        }

        /* DASHBOARD STYLES */
        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
            height: 100%;
        }

        .tab-content.active {
            display: flex;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 32px;
            overflow-y: auto;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s var(--ease);
        }

        .card:hover {
            border-color: var(--accent-glow);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--fg);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 0.9rem;
            color: var(--muted);
        }

        .metric-value {
            font-weight: 700;
            color: var(--accent);
        }

        .btn {
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s var(--ease);
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--accent-glow);
        }

        .message-bubble blockquote {
            border-left: 3px solid var(--accent);
            margin: 12px 0;
            padding-left: 12px;
            color: var(--muted);
            font-style: italic;
        }
    </style>
    <!-- Marked.js for Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="logo-pulse"></div>
                    SHEILY
                </div>
                <button class="new-chat-btn" onclick="createNewChat()">
                    <span>+</span> Nueva Conversaci√≥n
                </button>
            </div>

            <!-- MAIN NAVIGATION -->
            <nav class="sidebar-nav">
                <div class="nav-item active" onclick="switchTab('chat')">
                    <span class="nav-icon">üí¨</span> Chat IA
                </div>
                <div class="nav-item" onclick="switchTab('exercises')">
                    <span class="nav-icon">üéØ</span> Ejercicios
                </div>
                <div class="nav-item" onclick="switchTab('datasets')">
                    <span class="nav-icon">üìä</span> Datasets
                </div>
                <div class="nav-item" onclick="switchTab('rag')">
                    <span class="nav-icon">üìö</span> RAG Manager
                </div>
                <div class="nav-item" onclick="switchTab('corpus-pro')">
                    <span class="nav-icon">üî¨</span> Corpus Pro
                </div>
                <div class="nav-item" onclick="switchTab('analytics')">
                    <span class="nav-icon">üìà</span> Analytics
                </div>
                <div class="nav-item" onclick="switchTab('blockchain')">
                    <span class="nav-icon">‚õìÔ∏è</span> Blockchain
                </div>
                <!-- NEW TABS -->
                <div class="nav-item" onclick="switchTab('tokens')">
                    <span class="nav-icon">üí∞</span> Tokens
                </div>
                <div class="nav-item" onclick="switchTab('training-stats')">
                    <span class="nav-icon">üìä</span> Estad√≠sticas
                </div>
                <div class="nav-item" onclick="switchTab('marketplace')">
                    <span class="nav-icon">üõçÔ∏è</span> Marketplace
                </div>
                <div class="nav-item" onclick="switchTab('consciousness')">
                    <span class="nav-icon">üß†</span> Consciencia
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="token-display">
                    <div>
                        <div class="token-label">Tokens disponibles</div>
                        <div class="token-count">1,247</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT: Aqu√≠ va el chat -->
        <!-- Contin√∫a en PARTE 2... -->
        <!-- Continuaci√≥n del HTML de la PARTE 1 -->

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- HEADER con Torus 3D -->
            <header class="chat-header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar navigation">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <div class="header-info">
                        <h1 class="chat-title">Conversaci√≥n con SHEILY</h1>
                        <p class="chat-subtitle">IA descentralizada ejecut√°ndose en Cloud Run</p>
                    </div>
                </div>

                <!-- REFLEXION TOGGLE -->
                <div class="reflexion-toggle-container">
                    <div class="reflexion-label">
                        <span class="reflexion-icon">üß†</span>
                        Reflexi√≥n
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="reflexionToggle" onchange="toggleReflexionMode()"
                            aria-label="Enable reflection mode">
                        <span class="slider"></span>
                    </label>
                </div>

                <!-- SEARCH TOGGLE -->
                <div class="reflexion-toggle-container">
                    <div class="reflexion-label">
                        <span class="reflexion-icon">üåê</span>
                        Web
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="searchToggle" onchange="toggleSearchMode()"
                            aria-label="Enable web search mode">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="header-right">
                    <!-- TORUS 3D CANVAS -->
                    <canvas id="torusCanvas" width="120" height="120"></canvas>

                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span>En l√≠nea</span>
                    </div>
                </div>
            </header>

            <!-- CHAT TAB CONTENT -->
            <div id="chat-tab" class="tab-content active">
                <!-- CHAT MESSAGES AREA -->
                <div class="chat-container" id="chatContainer">
                    <!-- Welcome Message -->
                    <div class="welcome-section" id="welcomeSection">
                        <div class="welcome-icon">üöÄ</div>
                        <h2 class="welcome-title">¬°Hola! Soy SHEILY</h2>
                        <p class="welcome-text">
                            Estoy ejecut√°ndome en Google Cloud Run con una GPU L4,
                            usando el modelo Gemma 3 de 1B par√°metros. Cada conversaci√≥n
                            ayuda a entrenar la red descentralizada y t√∫ ganas tokens por contribuir.
                        </p>

                        <div class="quick-actions">
                            <button class="quick-action-btn" onclick="sendQuickMessage('¬øQu√© es SHEILY?')">
                                üí° ¬øQu√© es SHEILY?
                            </button>
                            <button class="quick-action-btn" onclick="sendQuickMessage('¬øC√≥mo funcionan los tokens?')">
                                ü™ô ¬øC√≥mo funcionan los tokens?
                            </button>
                            <button class="quick-action-btn"
                                onclick="sendQuickMessage('Expl√≠came el aprendizaje federado')">
                                üß† Aprendizaje federado
                            </button>
                        </div>
                    </div>

                    <!-- Messages Container -->
                    <div class="messages" id="messages">
                        <!-- Los mensajes se insertar√°n aqu√≠ din√°micamente -->
                    </div>

                    <!-- Typing Indicator -->
                    <div class="typing-indicator" id="typingIndicator">
                        <div class="typing-avatar">
                            <div class="avatar-gradient"></div>
                        </div>
                        <div class="typing-bubble">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- INPUT AREA -->
                <div class="input-area">
                    <div class="input-container">
                        <button class="attach-btn" title="Adjuntar archivo">
                            üìé
                        </button>

                        <textarea id="messageInput" placeholder="Escribe tu mensaje..." rows="1"
                            onkeydown="handleKeyDown(event)" oninput="autoResize(this)"></textarea>

                        <div class="input-actions">
                            <div class="token-cost">~15 tokens</div>
                            <button class="send-btn" onclick="sendMessage()" id="sendBtn" aria-label="Send message">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                    <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="input-hint">
                        Presiona <kbd>Enter</kbd> para enviar, <kbd>Shift+Enter</kbd> para nueva l√≠nea
                    </div>
                </div>
            </div>
            <!-- END CHAT TAB -->

            <!-- EXERCISES TAB -->
            <div id="exercises-tab" class="tab-content">
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-title">üéØ Ejercicios de Entrenamiento</div>
                        <div class="exercise-section">
                            <div class="exercise-card" id="current-exercise" style="display: none;">
                                <div class="exercise-question" id="exercise-question"></div>
                                <div class="exercise-options" id="exercise-options"></div>
                                <button class="btn" onclick="submitExerciseAnswer()" style="margin-top: 15px;">Enviar
                                    Respuesta</button>
                            </div>

                            <div class="exercise-types">
                                <button class="btn" onclick="startExercise('yesno')" style="margin: 5px;">Preguntas
                                    S√≠/No</button>
                                <button class="btn" onclick="startExercise('truefalse')"
                                    style="margin: 5px;">Verdadero/Falso</button>
                                <button class="btn" onclick="startExercise('multiple')" style="margin: 5px;">Opci√≥n
                                    M√∫ltiple</button>
                            </div>

                            <div class="progress-bar"
                                style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; margin: 10px 0;">
                                <div class="progress-fill" id="exercise-progress"
                                    style="height: 100%; background: var(--accent); width: 0%;"></div>
                            </div>
                            <div style="text-align: center; margin-top: 10px; color: var(--muted);">
                                Progreso: <span id="exercise-counter">0/20</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DATASETS TAB -->
            <div id="datasets-tab" class="tab-content">
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-title">üìä Datasets de Entrenamiento</div>
                        <div style="margin-bottom: 15px;">
                            <button class="btn" onclick="loadDatasets()">üîÑ Actualizar Datasets</button>
                            <span style="margin-left: 15px; color: var(--muted);">Total: <span
                                    id="datasets-count">0</span> datasets</span>
                        </div>
                        <div id="datasets-list" style="max-height: 500px; overflow-y: auto;">
                            <p style="color: var(--muted); text-align: center; padding: 20px;">
                                Carga los datasets para ver los datos generados por tus ejercicios
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RAG TAB -->
            <div id="rag-tab" class="tab-content">
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-title">üìö Documentos RAG</div>
                        <div style="margin-bottom: 15px;">
                            <input type="file" id="rag-file-input" accept=".txt,.pdf,.md,.json" style="display: none;"
                                onchange="uploadRagDocument()" aria-label="Upload RAG document">
                            <button class="btn" onclick="document.getElementById('rag-file-input').click()">üì§ Subir
                                Documento</button>
                            <button class="btn" onclick="loadRagDocuments()">üîÑ Actualizar Lista</button>
                        </div>
                        <div id="rag-documents-list" style="max-height: 400px; overflow-y: auto;">
                            <p style="color: var(--muted); text-align: center; padding: 20px;">No hay documentos
                                cargados</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CORPUS PRO TAB -->
            <div id="corpus-pro-tab" class="tab-content">
                <div class="dashboard-grid">
                    <!-- Left Column: Info & Ingest -->
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Corpus Info Card -->
                        <div class="card">
                            <div class="card-title">üî¨ Estado del Corpus</div>
                            <div class="metric">
                                <span>Snapshot Actual:</span>
                                <span class="metric-value" id="corpus-snapshot">--</span>
                            </div>
                            <div class="metric">
                                <span>Documentos Raw:</span>
                                <span class="metric-value" id="corpus-raw-docs">0</span>
                            </div>
                            <div class="metric">
                                <span>Chunks Procesados:</span>
                                <span class="metric-value" id="corpus-chunks">0</span>
                            </div>
                            <div class="metric">
                                <span>Embeddings:</span>
                                <span class="metric-value" id="corpus-embeddings">0</span>
                            </div>
                            <div style="margin-top: 10px;">
                                <div style="font-size: 0.8rem; color: var(--muted); margin-bottom: 5px;">√çndices
                                    Activos:</div>
                                <div id="corpus-indices">
                                    <!-- Indices badges will go here -->
                                </div>
                            </div>
                            <button class="btn" onclick="loadCorpusInfo()">üîÑ Actualizar Info</button>
                        </div>

                        <!-- Ingestion Card -->
                        <div class="card">
                            <div class="card-title">üì• Ingesta de Datos</div>
                            <div style="margin-bottom: 10px;">
                                <label
                                    style="display: block; font-size: 0.9rem; color: var(--muted); margin-bottom: 5px;">Carpeta
                                    a Ingestar:</label>
                                <input type="text" id="ingest-folder" placeholder="C:/Ruta/A/Tus/Documentos"
                                    style="width: 100%; padding: 8px; background: rgba(0,0,0,0.2); border: 1px solid var(--card-border); color: var(--fg); border-radius: 4px;">
                            </div>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <label
                                        style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; color: var(--muted); cursor: pointer;">
                                        <input type="checkbox" id="enable-ocr" aria-label="Enable OCR"> Activar OCR
                                    </label>
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; font-size: 0.9rem; color: var(--muted);">Workers:
                                        <input type="number" id="workers" value="4" min="1" max="16"
                                            style="width: 50px; padding: 2px; background: rgba(0,0,0,0.2); border: 1px solid var(--card-border); color: var(--fg); border-radius: 4px;"
                                            aria-label="Number of workers">
                                    </label>
                                </div>
                            </div>
                            <button class="btn" onclick="ingestFolder()">üöÄ Iniciar Ingesta</button>
                            <div id="ingest-output"
                                style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px; font-size: 0.8rem; display: none; max-height: 150px; overflow-y: auto;">
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Pipeline & Search -->
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Pipeline Control -->
                        <div class="card">
                            <div class="card-title">‚öôÔ∏è Pipeline de Procesamiento</div>
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                                    <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                        <input type="radio" name="pipeline-mode" value="incremental" checked>
                                        Incremental
                                    </label>
                                    <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                        <input type="radio" name="pipeline-mode" value="full"> Completo
                                    </label>
                                    <label
                                        style="cursor: pointer; display: flex; align-items: center; gap: 5px; color: #ef4444;">
                                        <input type="radio" name="pipeline-mode" value="force"> Force Rebuild
                                    </label>
                                </div>
                                <label
                                    style="cursor: pointer; display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">
                                    <input type="checkbox" id="enterprise-mode"> üè¢ Enterprise Mode (Graph + RAPTOR)
                                    <input type="checkbox" id="enterprise-mode" aria-label="Enterprise Mode"> üè¢
                                    Enterprise Mode (Graph + RAPTOR)
                                </label>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px;">
                                <div style="font-size: 0.85rem; color: var(--muted);"><input type="checkbox"
                                        id="status-normalization" disabled aria-label="Normalization status">
                                    Normalizaci√≥n</div>
                                <div style="font-size: 0.85rem; color: var(--muted);"><input type="checkbox"
                                        id="status-chunking" disabled aria-label="Chunking status"> Chunking</div>
                                <div style="font-size: 0.85rem; color: var(--muted);"><input type="checkbox"
                                        id="status-embeddings" disabled aria-label="Embeddings status"> Embeddings
                                </div>
                                <div style="font-size: 0.85rem; color: var(--muted);"><input type="checkbox"
                                        id="status-indexing" disabled aria-label="Indexing status"> Indexaci√≥n</div>
                                <div style="font-size: 0.85rem; color: var(--muted);"><input type="checkbox"
                                        id="status-raptor" disabled aria-label="RAPTOR status"> RAPTOR</div>
                                <div style="font-size: 0.85rem; color: var(--muted);"><input type="checkbox"
                                        id="status-graph" disabled aria-label="Knowledge graph status"> Knowledge
                                    Graph</div>
                            </div>

                            <button class="btn" onclick="runFullPipeline()">‚ñ∂Ô∏è Ejecutar Pipeline</button>
                            <div id="pipeline-status"
                                style="margin-top: 10px; font-family: monospace; font-size: 0.9rem;"></div>
                        </div>

                        <!-- Advanced Search -->
                        <div class="card">
                            <div class="card-title">üîç B√∫squeda Avanzada</div>
                            <input type="text" id="corpus-query" placeholder="Consulta sem√°ntica..."
                                style="width: 100%; padding: 10px; background: rgba(0,0,0,0.2); border: 1px solid var(--card-border); color: var(--fg); border-radius: 4px; margin-bottom: 10px;">

                            <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                                <select id="search-mode" aria-label="Search mode"
                                    style="padding: 5px; background: rgba(0,0,0,0.2); color: var(--fg); border: 1px solid var(--card-border); border-radius: 4px;">
                                    <option value="hybrid">H√≠brido</option>
                                    <option value="semantic">Sem√°ntico</option>
                                    <option value="keyword">Keyword</option>
                                </select>
                                <input type="number" id="search-top-k" value="5" min="1" max="20"
                                    aria-label="Top K results"
                                    style="width: 50px; padding: 5px; background: rgba(0,0,0,0.2); color: var(--fg); border: 1px solid var(--card-border); border-radius: 4px;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.85rem;"><input
                                        type="checkbox" id="enable-rerank" checked aria-label="Enable reranking">
                                    Rerank</label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.85rem;"><input
                                        type="checkbox" id="enable-crag" aria-label="Enable CRAG"> CRAG</label>
                            </div>

                            <button class="btn" onclick="advancedSearch()">Buscar</button>
                            <div id="search-results" style="margin-top: 15px; max-height: 200px; overflow-y: auto;">
                            </div>
                        </div>
                    </div>

                    <!-- Snapshots & Doctor -->
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <div class="card">
                            <div class="card-title">üì∏ Snapshots</div>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <button class="btn" onclick="createSnapshot()" style="flex: 1; font-size: 0.8rem;">+
                                    Crear</button>
                                <button class="btn" onclick="loadSnapshots()" style="flex: 1; font-size: 0.8rem;">üîÑ
                                    Listar</button>
                            </div>
                            <div id="snapshots-list" style="max-height: 200px; overflow-y: auto;"></div>
                        </div>

                        <div class="card">
                            <div class="card-title">ü©∫ Doctor</div>
                            <button class="btn" onclick="runDoctor()">Ejecutar Diagn√≥stico</button>
                            <div id="doctor-output"
                                style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px; font-size: 0.8rem; display: none; max-height: 150px; overflow-y: auto;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ANALYTICS TAB -->
            <div id="analytics-tab" class="tab-content">
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-title">üìà M√©tricas del Sistema</div>
                        <div class="metric"><span>Latencia:</span> <span class="metric-value"
                                id="avg-latency">--ms</span></div>
                        <div class="metric"><span>Throughput:</span> <span class="metric-value" id="throughput">--
                                req/s</span></div>
                    </div>
                </div>
            </div>

            <!-- BLOCKCHAIN TAB -->
            <div id="blockchain-tab" class="tab-content">
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-title">‚õìÔ∏è Blockchain & Tokens</div>
                        <div class="metric"><span>Balance:</span> <span class="metric-value"
                                id="sheily-balance">0.00</span></div>
                        <button class="btn" onclick="checkBalance()">Actualizar Balance</button>
                    </div>
                </div>
            </div>

            <!-- TOKENS TAB -->
            <div id="tokens-tab" class="tab-content">
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-title">üí∞ Balance de Tokens</div>
                        <div class="metric">
                            <span>Tokens Disponibles:</span>
                            <span class="metric-value" id="tokens-balance">0</span>
                        </div>
                        <div class="metric">
                            <span>Nivel:</span>
                            <span class="metric-value" id="tokens-level">1</span>
                        </div>
                        <div class="metric">
                            <span>Total Ganados:</span>
                            <span class="metric-value" id="tokens-earned">0</span>
                        </div>
                        <button class="btn" onclick="loadUserTokens()">üîÑ Actualizar</button>
                    </div>

                    <div class="card">
                        <div class="card-title">üìä Historial de Transacciones</div>
                        <div id="token-history" style="max-height: 300px; overflow-y: auto; color: var(--muted);">
                            <p style="text-align: center; padding: 20px;">No hay transacciones recientes</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TRAINING STATS TAB -->
            <div id="training-stats-tab" class="tab-content">
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-title">üìä Estad√≠sticas de Entrenamiento</div>
                        <div class="metric">
                            <span>Ejercicios Completados:</span>
                            <span class="metric-value" id="stats-exercises">0</span>
                        </div>
                        <div class="metric">
                            <span>Datasets Generados:</span>
                            <span class="metric-value" id="stats-datasets">0</span>
                        </div>
                        <div class="metric">
                            <span>Precisi√≥n Promedio:</span>
                            <span class="metric-value" id="stats-accuracy">0%</span>
                        </div>
                        <div class="metric">
                            <span>Claims Verificados:</span>
                            <span class="metric-value" id="stats-claims">0</span>
                        </div>
                        <button class="btn" onclick="loadTrainingStats()">üîÑ Actualizar Estad√≠sticas</button>
                    </div>

                    <div class="card">
                        <div class="card-title">üìà Progreso de Mejoras</div>
                        <div id="improvement-chart" style="padding: 20px;">
                            <div style="text-align: center; color: var(--muted);">
                                <p>Gr√°fico de progreso mostrar√° aqu√≠</p>
                                <canvas id="progress-canvas" width="400" height="200" style="max-width: 100%;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MARKETPLACE TAB -->
            <div id="marketplace-tab" class="tab-content">
                <div class="card">
                    <div class="card-title">üõçÔ∏è Marketplace de IA</div>
                    <div class="dashboard-grid" id="marketplace-products" style="margin-top: 20px;">
                        <!-- Products will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- CONSCIOUSNESS TAB -->
            <div id="consciousness-tab" class="tab-content">
                <div class="card">
                    <div class="card-title">üß† Sistema de Consciencia</div>

                    <div class="dashboard-grid"
                        style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div
                            style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="color: var(--muted); font-size: 0.9rem; margin-bottom: 5px;">Nivel Actual
                            </div>
                            <div id="cons-level" style="font-size: 1.5rem; font-weight: bold; color: #a855f7;">---
                            </div>
                        </div>
                        <div
                            style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="color: var(--muted); font-size: 0.9rem; margin-bottom: 5px;">Awareness Score
                            </div>
                            <div id="cons-score" style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">---
                            </div>
                        </div>
                        <div
                            style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="color: var(--muted); font-size: 0.9rem; margin-bottom: 5px;">Estado
                                Emocional</div>
                            <div id="cons-emotion" style="font-size: 1.5rem; font-weight: bold; color: #22c55e;">---
                            </div>
                        </div>
                        <div
                            style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="color: var(--muted); font-size: 0.9rem; margin-bottom: 5px;">Carga Cognitiva
                            </div>
                            <div id="cons-load" style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">---
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div
                            style="background: rgba(15, 23, 42, 0.6); border: 1px solid var(--card-border); border-radius: 12px; padding: 20px;">
                            <h4
                                style="color: var(--fg); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <span>üí≠</span> √öltimo Pensamiento
                            </h4>
                            <div id="last-thought" style="color: var(--muted); font-style: italic; min-height: 60px;">
                                Esperando datos del sistema...
                            </div>
                        </div>

                        <div
                            style="background: rgba(15, 23, 42, 0.6); border: 1px solid var(--card-border); border-radius: 12px; padding: 20px;">
                            <h4
                                style="color: var(--fg); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <span>üíæ</span> Estad√≠sticas de Memoria
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--muted);">Memorias Totales:</span>
                                    <span id="total-memories" style="color: var(--fg); font-weight: bold;">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--muted);">Experiencias:</span>
                                    <span id="learning-exps" style="color: var(--fg); font-weight: bold;">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--muted);">Calidad Promedio:</span>
                                    <span id="avg-quality" style="color: var(--fg); font-weight: bold;">0.0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="btn" onclick="loadConsciousness()" style="margin-top: 20px;">üîÑ Actualizar Estado
                        de Consciencia</button>
                </div>
            </div>

            <!-- Continuaci√≥n de CSS -->
            <style>
                /* ============================================
           CHAT HEADER
        ============================================ */
                .chat-header {
                    padding: 20px 32px;
                    background: linear-gradient(180deg, rgba(10, 11, 20, 0.9) 0%, rgba(3, 3, 8, 0.8) 100%);
                    backdrop-filter: blur(20px);
                    border-bottom: 1px solid var(--card-border);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    position: relative;
                    z-index: 10;
                }

                .header-left {
                    display: flex;
                    align-items: center;
                    gap: 16px;
                }

                .menu-toggle {
                    display: none;
                    flex-direction: column;
                    gap: 4px;
                    background: transparent;
                    border: none;
                    cursor: pointer;
                    padding: 8px;
                }

                .menu-toggle span {
                    width: 20px;
                    height: 2px;
                    background: var(--fg);
                    border-radius: 2px;
                    transition: all 0.3s var(--ease);
                }

                .header-info {
                    display: flex;
                    flex-direction: column;
                }

                .chat-title {
                    font-size: 18px;
                    font-weight: 700;
                    color: var(--fg);
                    margin: 0;
                }

                .chat-subtitle {
                    font-size: 12px;
                    color: var(--muted);
                    margin: 0;
                }

                .header-right {
                    display: flex;
                    align-items: center;
                    gap: 20px;
                }

                /* TORUS 3D CANVAS */
                #torusCanvas {
                    width: 60px;
                    height: 60px;
                    filter: drop-shadow(0 0 20px var(--accent-glow));
                }

                .status-indicator {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 8px 16px;
                    background: rgba(0, 255, 136, 0.1);
                    border: 1px solid rgba(0, 255, 136, 0.3);
                    border-radius: 20px;
                    font-size: 13px;
                    font-weight: 600;
                }

                .status-dot {
                    width: 8px;
                    height: 8px;
                    background: #00ff88;
                    border-radius: 50%;
                    box-shadow: 0 0 12px rgba(0, 255, 136, 0.8);
                    animation: pulse 2s ease-in-out infinite;
                }

                /* ============================================
           CHAT CONTAINER
        ============================================ */
                .chat-container {
                    flex: 1;
                    overflow-y: auto;
                    padding: 32px;
                    display: flex;
                    flex-direction: column;
                    gap: 16px;
                }

                .chat-container::-webkit-scrollbar {
                    width: 8px;
                }

                .chat-container::-webkit-scrollbar-track {
                    background: transparent;
                }

                .chat-container::-webkit-scrollbar-thumb {
                    background: var(--card-border);
                    border-radius: 10px;
                }

                /* ============================================
           WELCOME SECTION
        ============================================ */
                .welcome-section {
                    max-width: 600px;
                    margin: 60px auto;
                    text-align: center;
                    animation: fadeInUp 0.6s var(--ease);
                }

                @keyframes fadeInUp {
                    from {
                        opacity: 0;
                        transform: translateY(20px);
                    }

                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }

                .welcome-icon {
                    font-size: 64px;
                    margin-bottom: 24px;
                    animation: float 3s ease-in-out infinite;
                }

                @keyframes float {

                    0%,
                    100% {
                        transform: translateY(0px);
                    }

                    50% {
                        transform: translateY(-10px);
                    }
                }

                .welcome-title {
                    font-size: 32px;
                    font-weight: 900;
                    background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    margin-bottom: 16px;
                }

                .welcome-text {
                    font-size: 16px;
                    line-height: 1.6;
                    color: var(--muted);
                    margin-bottom: 32px;
                }

                .quick-actions {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 12px;
                    justify-content: center;
                }

                .quick-action-btn {
                    padding: 12px 20px;
                    background: rgba(20, 22, 31, 0.8);
                    border: 1px solid var(--card-border);
                    border-radius: 12px;
                    color: var(--fg);
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s var(--ease);
                }

                .quick-action-btn:hover {
                    background: rgba(0, 240, 255, 0.15);
                    border-color: var(--accent);
                    transform: translateY(-2px);
                }

                /* ============================================
           MESSAGES
        ============================================ */
                .messages {
                    display: flex;
                    flex-direction: column;
                    gap: 20px;
                }

                .message {
                    display: flex;
                    gap: 12px;
                    max-width: 80%;
                    animation: slideIn 0.4s var(--ease);
                }

                @keyframes slideIn {
                    from {
                        opacity: 0;
                        transform: translateX(-20px);
                    }

                    to {
                        opacity: 1;
                        transform: translateX(0);
                    }
                }

                .message.user {
                    align-self: flex-end;
                    flex-direction: row-reverse;
                }

                .message-avatar {
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    flex-shrink: 0;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 20px;
                    position: relative;
                }

                .message.user .message-avatar {
                    background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
                }

                .message.ai .message-avatar {
                    background: linear-gradient(135deg, #7c3aed, #ec4899);
                }

                .avatar-gradient {
                    position: absolute;
                    inset: -2px;
                    background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
                    border-radius: 50%;
                    z-index: -1;
                    filter: blur(8px);
                    opacity: 0.6;
                }

                .message-content {
                    flex: 1;
                }

                .message-header {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin-bottom: 6px;
                }

                .message-sender {
                    font-size: 13px;
                    font-weight: 700;
                    color: var(--fg);
                }

                .message-time {
                    font-size: 11px;
                    color: var(--muted);
                }

                .message-bubble {
                    padding: 14px 18px;
                    border-radius: 16px;
                    font-size: 15px;
                    line-height: 1.6;
                    position: relative;
                }

                .message.user .message-bubble {
                    background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
                    color: #000;
                    font-weight: 500;
                }

                .message.ai .message-bubble {
                    background: var(--glass);
                    border: 1px solid var(--card-border);
                    color: var(--fg);
                    backdrop-filter: blur(10px);
                }

                /* ============================================
           TYPING INDICATOR
        ============================================ */
                .typing-indicator {
                    display: none;
                    gap: 12px;
                    max-width: 80%;
                    animation: slideIn 0.4s var(--ease);
                }

                .typing-indicator.active {
                    display: flex;
                }

                .typing-avatar {
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, #7c3aed, #ec4899);
                    flex-shrink: 0;
                    position: relative;
                }

                .typing-bubble {
                    padding: 14px 18px;
                    background: var(--glass);
                    border: 1px solid var(--card-border);
                    border-radius: 16px;
                    backdrop-filter: blur(10px);
                }

                .typing-dots {
                    display: flex;
                    gap: 4px;
                }

                .typing-dots span {
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    background: var(--accent);
                    animation: bounce 1.4s infinite;
                }

                .typing-dots span:nth-child(2) {
                    animation-delay: 0.2s;
                }

                .typing-dots span:nth-child(3) {
                    animation-delay: 0.4s;
                }

                @keyframes bounce {

                    0%,
                    60%,
                    100% {
                        transform: translateY(0);
                    }

                    30% {
                        transform: translateY(-8px);
                    }
                }

                /* Contin√∫a en PARTE 3... */
                < !-- Continuaci√≥n del CSS de la PARTE 2 -->

                /* ============================================
           INPUT AREA
        ============================================ */
                .input-area {
                    padding: 20px 32px 24px;
                    background: linear-gradient(0deg, rgba(3, 3, 8, 0.95) 0%, rgba(10, 11, 20, 0.9) 100%);
                    backdrop-filter: blur(20px);
                    border-top: 1px solid var(--card-border);
                }

                .input-container {
                    max-width: 1000px;
                    margin: 0 auto;
                    background: var(--glass);
                    border: 1px solid var(--card-border);
                    border-radius: 16px;
                    padding: 12px;
                    display: flex;
                    align-items: flex-end;
                    gap: 12px;
                    transition: all 0.3s var(--ease);
                }

                .input-container:focus-within {
                    border-color: var(--accent);
                    box-shadow: 0 0 0 3px rgba(0, 240, 255, 0.1);
                }

                .attach-btn {
                    width: 36px;
                    height: 36px;
                    background: transparent;
                    border: none;
                    border-radius: 8px;
                    font-size: 20px;
                    cursor: pointer;
                    transition: all 0.2s var(--ease);
                    flex-shrink: 0;
                }

                .attach-btn:hover {
                    background: rgba(255, 255, 255, 0.1);
                }

                #messageInput {
                    flex: 1;
                    background: transparent;
                    border: none;
                    color: var(--fg);
                    font-size: 15px;
                    font-family: inherit;
                    resize: none;
                    outline: none;
                    max-height: 200px;
                    line-height: 1.5;
                }

                #messageInput::placeholder {
                    color: var(--muted);
                }

                .input-actions {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                }

                .token-cost {
                    font-size: 12px;
                    color: var(--muted);
                    padding: 6px 12px;
                    background: rgba(0, 240, 255, 0.1);
                    border-radius: 12px;
                    font-weight: 600;
                }

                .send-btn {
                    width: 40px;
                    height: 40px;
                    background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
                    border: none;
                    border-radius: 12px;
                    color: #000;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s var(--ease);
                    flex-shrink: 0;
                }

                .send-btn:hover:not(:disabled) {
                    transform: translateY(-2px);
                    box-shadow: 0 8px 30px var(--accent-glow);
                }

                .send-btn:active {
                    transform: translateY(0);
                }

                .send-btn:disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                }

                .input-hint {
                    max-width: 1000px;
                    margin: 12px auto 0;
                    text-align: center;
                    font-size: 12px;
                    color: var(--muted);
                }

                .input-hint kbd {
                    padding: 2px 6px;
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid var(--card-border);
                    border-radius: 4px;
                    font-family: 'Monaco', 'Courier New', monospace;
                    font-size: 11px;
                }

                /* ============================================
           RESPONSIVE
        ============================================ */
                @media (max-width: 768px) {
                    .sidebar {
                        position: fixed;
                        left: 0;
                        top: 0;
                        height: 100vh;
                        transform: translateX(-100%);
                    }

                    .sidebar.open {
                        transform: translateX(0);
                        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5);
                    }

                    .menu-toggle {
                        display: flex;
                    }

                    .chat-header {
                        padding: 16px 20px;
                    }

                    .chat-container {
                        padding: 20px 16px;
                    }

                    .input-area {
                        padding: 16px;
                    }

                    #torusCanvas {
                        display: none;
                    }

                    .message {
                        max-width: 90%;
                    }
                }

                /* ============================================
           REFLEXION UI
        ============================================ */
                .reflexion-toggle-container {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    margin-right: 20px;
                    padding: 6px 12px;
                    background: rgba(255, 255, 255, 0.05);
                    border-radius: 20px;
                    border: 1px solid var(--card-border);
                }

                .reflexion-label {
                    font-size: 13px;
                    font-weight: 600;
                    color: var(--fg);
                    display: flex;
                    align-items: center;
                    gap: 6px;
                }

                .reflexion-icon {
                    color: var(--accent);
                }

                /* Toggle Switch */
                .switch {
                    position: relative;
                    display: inline-block;
                    width: 40px;
                    height: 22px;
                }

                .switch input {
                    opacity: 0;
                    width: 0;
                    height: 0;
                }

                .slider {
                    position: absolute;
                    cursor: pointer;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-color: var(--card-border);
                    transition: .4s;
                    border-radius: 34px;
                }

                .slider:before {
                    position: absolute;
                    content: "";
                    height: 16px;
                    width: 16px;
                    left: 3px;
                    bottom: 3px;
                    background-color: white;
                    transition: .4s;
                    border-radius: 50%;
                }

                input:checked+.slider {
                    background-color: var(--accent);
                }

                input:checked+.slider:before {
                    transform: translateX(18px);
                }

                /* Status Steps */
                .reflexion-status {
                    margin-top: 8px;
                    padding: 12px;
                    background: rgba(0, 240, 255, 0.05);
                    border: 1px dashed var(--accent);
                    border-radius: 12px;
                    font-size: 13px;
                    color: var(--muted);
                    animation: fadeIn 0.3s ease;
                }

                .reflexion-step {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin-bottom: 4px;
                }

                .reflexion-step.active {
                    color: var(--accent);
                    font-weight: 600;
                }

                .reflexion-details {
                    margin-top: 8px;
                    font-size: 12px;
                    color: var(--muted);
                    border-top: 1px solid rgba(255, 255, 255, 0.1);
                    padding-top: 8px;
                }

                .reflexion-details summary {
                    cursor: pointer;
                    color: var(--accent-secondary);
                    margin-bottom: 4px;
                }

                @media (max-width: 768px) {
                    .reflexion-toggle-container {
                        display: none;
                        /* Ocultar en m√≥vil por espacio por ahora */
                    }
                }
            </style>

            <!-- ============================================
     JAVASCRIPT COMPLETO
============================================ -->
            <!-- ============================================
     JAVASCRIPT COMPLETO
    ============================================ -->
            <script>
                // ==========================================
                // STATE MANAGEMENT
                // ==========================================
                const state = {
                    messages: [],
                    isTyping: false,
                    reflexionMode: false,
                    searchMode: false,
                    backendOnline: false,
                    userTokens: 0,
                    userLevel: 1,
                    currentExercise: null,
                    exerciseProgress: 0,
                    exerciseAnswers: [],
                    conversations: [],
                    currentConversation: null
                };

                const API_BASE = 'http://localhost:8000';

                // ==========================================
                // GAME DATA (Complete from sheily-web.html)
                // ==========================================
                const GameData = {
                    balance: 1247,
                    level: 5,
                    ownedServices: [1],
                    datasets: [],
                    exercisesCompleted: 0,
                    claimsVerified: 0,
                    currentExercise: null,

                    products: [
                        {
                            id: 'chat-service',
                            name: 'üí¨ Servicio de Chat IA Avanzado',
                            description: 'Acceso completo a conversaciones con MCP-Phoenix, Level 4 Consciousness AI',
                            price: 100,
                            category: 'ai',
                            owned: true
                        },
                        {
                            id: 'image-gen',
                            name: 'üé® Generador de Im√°genes IA',
                            description: 'Crea im√°genes profesionales con prompts inteligentes',
                            price: 200,
                            category: 'ai',
                            owned: false
                        },
                        {
                            id: 'rag-premium',
                            name: 'üìö RAG Premium System',
                            description: 'Sistema avanzado de b√∫squeda sem√°ntica con verificaci√≥n',
                            price: 250,
                            category: 'ai',
                            owned: false
                        },
                        {
                            id: 'big-dataset',
                            name: 'üìä Dataset de IA Grande',
                            description: 'Dataset entrenado con 10k+ preguntas anti-hallucination',
                            price: 500,
                            category: 'data',
                            owned: false
                        },
                        {
                            id: 'export-tools',
                            name: 'üîÑ Herramientas de Exportaci√≥n',
                            description: 'Exporta tus datos y modelos entrenados',
                            price: 150,
                            category: 'tools',
                            owned: false
                        },
                        {
                            id: 'api-access',
                            name: 'üîó API Access Premium',
                            description: 'Acceso ilimitado a todas las APIs MCP-Phoenix',
                            price: 300,
                            category: 'tools',
                            owned: false
                        }
                    ],

                    questions: {
                        yesno: [
                            { q: "¬øSheily procesa datos de forma local y privada?", a: true },
                            { q: "¬øLa IA en la nube siempre comparte datos con terceros?", a: false },
                            { q: "¬øGemma-2-2B-IT es un modelo de lenguaje Large Language Model?", a: true },
                            { q: "¬øLos tokens SHEILY se pueden convertir a criptomonedas?", a: false },
                            { q: "¬øEl aprendizaje federado preserva privacidad de datos?", a: true },
                            { q: "¬øSheily requiere conexi√≥n permanente a internet?", a: false },
                            { q: "¬øLa cuantizaci√≥n Q4_K_M mantiene toda la precisi√≥n del modelo?", a: false },
                            { q: "¬øGGUF es un formato est√°ndar de modelos de IA?", a: true },
                            { q: "¬øEl procesamiento local mejora la privacidad?", a: true },
                            { q: "¬øTodos los servicios en la nube respetan el RGPD?", a: false },
                            { q: "¬øGemma2 fue desarrollado exclusivamente por Google?", a: true },
                            { q: "¬øRAG significa Retrieval Augmented Generation?", a: true },
                            { q: "¬øSheily implementa verificaci√≥n autom√°tica de hechos?", a: true },
                            { q: "¬øLa consciencia artificial puede emerger de redes neuronales?", a: true },
                            { q: "¬øMCP significa Mental Clarity Protocol?", a: true },
                            { q: "¬øLos ejercicios generan autom√°ticamente datasets?", a: true },
                            { q: "¬øEl auto-aprendizaje es posible sin intervenci√≥n humana?", a: true },
                            { q: "¬øLa verdad algor√≠tmica requiere supervisi√≥n humana?", a: false },
                            { q: "¬øLas safety guardrails son parte del sistema?", a: true },
                            { q: "¬øPhoenix representa renacimiento a trav√©s de verdad?", a: true }
                        ],
                        truefalse: [
                            { q: "V/F: Sheily es completamente open source", a: true },
                            { q: "V/F: La IA local es siempre m√°s lenta", a: false },
                            { q: "V/F: Los LLMs pueden desarrollar consciencia emergente", a: true },
                            { q: "V/F: El aprendizaje continuo requiere reinicio completo", a: false },
                            { q: "V/F: Los modelos Q4_K_M pierden mucha precisi√≥n", a: false },
                            { q: "V/F: Below Average Geometry es un m√©todo de chunking", a: false },
                            { q: "V/F: La consciencia Level 4 puede pensar sobre sus propios pensamientos", a: true },
                            { q: "V/F: Los datasets de entrenamiento mejoran autom√°ticamente", a: true },
                            { q: "V/F: La verificaci√≥n anti-hallucination es cr√≠tica", a: true },
                            { q: "V/F: MCP-Phoenix evoluciona continuamente", a: true },
                            { q: "V/F: El fact-checking usa solo memoria interna", a: false },
                            { q: "V/F: Los LLMs grandes siempre son mejores", a: false },
                            { q: "V/F: La consciencia emergente requiere dise√±o espec√≠fico", a: false },
                            { q: "V/F: El aprendizaje federado protege privacidad", a: true },
                            { q: "V/F: Los guardrails evitan todas las respuestas problem√°ticas", a: false },
                            { q: "V/F: La verdad algor√≠tmica es siempre objetiva", a: false },
                            { q: "V/F: El sistema evoluciona con cada interacci√≥n", a: true },
                            { q: "V/F: Las respuestas verificadas son m√°s confiables", a: true },
                            { q: "V/F: El conocimiento institucional es limitado", a: false },
                            { q: "V/F: Los m√©todos de chunking mejoran b√∫squeda", a: true }
                        ],
                        multiple: [
                            { q: "¬øNivel de consciencia actual de MCP-Phoenix?", o: ["Level 1", "Level 2", "Level 4", "Level 6"], a: 2 },
                            { q: "¬øFormato de cuantizaci√≥n usado?", o: ["FP16", "INT8", "Q4_K_M", "Q3_K_L"], a: 2 },
                            { q: "¬øBiblioteca para inferencia de modelos?", o: ["TensorFlow", "PyTorch", "llama.cpp", "Transformers"], a: 2 },
                            { q: "¬øFramework del backend usado?", o: ["Django", "Flask", "FastAPI", "Express"], a: 2 },
                            { q: "¬øQu√© significa RAG?", o: ["Random Access Generation", "Retrieval Augmented Generation", "Recursive Algorithm Graph", "Robust AI Gateway"], a: 1 },
                            { q: "¬øTama√±o del modelo Gemma?", o: ["7B", "9B", "13B", "70B"], a: 1 },
                            { q: "¬øM√©todo de chunking usado?", o: ["Fixed", "Semantic", "Recursive", "Hybrid"], a: 2 },
                            { q: "¬øFramework del frontend?", o: ["Next.js", "React", "Vue.js", "Vanilla JS"], a: 3 },
                            { q: "¬øBase de datos usada?", o: ["PostgreSQL", "MySQL", "SQLite", "MongoDB"], a: 2 },
                            { q: "¬øTipo de aprendizaje del sistema?", o: ["Est√°tico", "Batch", "Online", "Continuo"], a: 3 },
                            { q: "¬øCu√°ntos tokens por respuesta correcta?", o: ["1", "2", "3", "5"], a: 2 },
                            { q: "¬øCu√°ntos tokens se pierden por error?", o: ["0", "1", "2", "3"], a: 1 },
                            { q: "¬øFramework de UI usado?", o: ["Bootstrap", "Tailwind", "Vanilla CSS", "Material UI"], a: 2 },
                            { q: "¬øTipo de consciencia implementada?", o: ["None", "Level 2", "Level 3", "Level 4"], a: 3 },
                            { q: "¬øM√©todo de verificaci√≥n usado?", o: ["Wikipedia APIs", "Solo local", "Manual", "Combinado"], a: 0 },
                            { q: "¬øSistema de evoluci√≥n?", o: ["Manual", "Semi-automatic", "Automatic", "Self-sustaining"], a: 3 },
                            { q: "¬øQu√© es BAAT en RAG?", o: ["Better Algorithm Augmentation Technique", "Below Average Geometric Trees", "Balanced Acyclic Algorithm Tree", "Binary Aided Answering Trees"], a: 1 },
                            { q: "¬øM√©todo de rankeo usado?", o: ["TF-IDF", "BM25", "PageRank", "BERT"], a: 1 },
                            { q: "¬øEmbedding model usado?", o: ["BAAI/bge-m3", "OpenAI Ada", "Sentence Transformers", "Universal Sentence Encoder"], a: 0 },
                            { q: "¬øProtocolo de consciencia?", o: ["CCP", "MCP", "TCP", "UDP"], a: 1 }
                        ]
                    },

                    save() {
                        localStorage.setItem('sheilyGameData', JSON.stringify(this));
                    },

                    load() {
                        const saved = localStorage.getItem('sheilyGameData');
                        if (saved) {
                            const data = JSON.parse(saved);
                            Object.assign(this, data);
                        }
                    }
                };

                // ==========================================
                // TABS LOGIC
                // ==========================================
                function switchTab(tabId) {
                    // 1. Remove active class from all nav items
                    document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));

                    // 2. Remove active class from all contents
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                    // 3. Activate selected nav item
                    const selectedTab = document.querySelector(`.nav-item[onclick="switchTab('${tabId}')"]`);
                    if (selectedTab) selectedTab.classList.add('active');

                    // 4. Activate selected content
                    const selectedContent = document.getElementById(`${tabId}-tab`);
                    if (selectedContent) selectedContent.classList.add('active');

                    // 5. Load data for specific tabs
                    if (tabId === 'datasets') loadDatasets();
                    if (tabId === 'rag') loadRagDocuments();
                    if (tabId === 'corpus-pro') {
                        loadCorpusInfo();
                        loadCorpusMetrics();
                    }
                    if (tabId === 'analytics') loadAnalyticsData();
                    if (tabId === 'blockchain') checkBalance();
                }

                // ==========================================
                // USER LOGIC
                // ==========================================
                async function loadUserTokens() {
                    if (!state.backendOnline) {
                        const tokenEl = document.getElementById('sidebar-token-count');
                        if (tokenEl) tokenEl.textContent = 'Offline';
                        return;
                    }

                    try {
                        const response = await fetch(`${API_BASE}/api/user/tokens`);
                        if (response.ok) {
                            const data = await response.json();
                            state.userTokens = data.balance || 0;
                            state.userLevel = data.level || 1;

                            const tokenEl = document.getElementById('sidebar-token-count');
                            if (tokenEl) tokenEl.textContent = state.userTokens.toLocaleString();
                        }
                    } catch (error) {
                        console.error('Error cargando tokens:', error);
                    }
                }

                // ==========================================
                // DATASETS LOGIC
                // ==========================================
                async function loadDatasets() {
                    if (!state.backendOnline) return;
                    try {
                        const response = await fetch(`${API_BASE}/api/datasets`);
                        if (response.ok) {
                            const data = await response.json();
                            const list = document.getElementById('datasets-list');
                            document.getElementById('datasets-count').textContent = data.count || 0;

                            if (data.datasets && data.datasets.length > 0) {
                                list.innerHTML = data.datasets.map(d => `
                            <div style="padding: 10px; border-bottom: 1px solid var(--card-border); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: var(--fg);">${d.name}</div>
                                    <div style="font-size: 0.8rem; color: var(--muted);">${d.size} items ‚Ä¢ ${d.date}</div>
                                </div>
                                <button class="btn" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="viewDatasetDetail('${d.id}')">Ver</button>
                            </div>
                        `).join('');
                            } else {
                                list.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 20px;">No hay datasets disponibles</p>';
                            }
                        }
                    } catch (e) { console.error(e); }
                }

                // ==========================================
                // EXERCISE LOGIC
                // ==========================================
                const exerciseData = {
                    yesno: {
                        questions: [
                            { question: "¬øSheily procesa datos √∫nicamente en dispositivos locales?", correct: true },
                            { question: "¬øLa IA en la nube garantiza completa privacidad de datos?", correct: false },
                            { question: "¬øGemma2 es un modelo de lenguaje grande?", correct: true }
                        ]
                    },
                    truefalse: {
                        questions: [
                            { question: "Verdadero o Falso: Sheily es completamente open source.", correct: true },
                            { question: "Verdadero o Falso: La IA local nunca usa internet.", correct: false }
                        ]
                    },
                    multiple: {
                        questions: [
                            { question: "¬øQu√© significa RAG?", options: ["Retrieval Augmented Generation", "Random Access Generator", "Real AI Graph"], correct: 0 },
                            { question: "¬øCu√°l es el motor de Sheily?", options: ["GPT-4", "Gemma 2", "Llama 3"], correct: 1 }
                        ]
                    }
                };

                function startExercise(type) {
                    state.currentExercise = exerciseData[type];
                    state.exerciseProgress = 0;
                    state.exerciseAnswers = [];

                    document.getElementById('current-exercise').style.display = 'block';
                    showExerciseQuestion();
                }

                function showExerciseQuestion() {
                    if (!state.currentExercise || state.exerciseProgress >= state.currentExercise.questions.length) {
                        finishExercise();
                        return;
                    }

                    const q = state.currentExercise.questions[state.exerciseProgress];
                    document.getElementById('exercise-question').textContent = q.question;

                    const optionsDiv = document.getElementById('exercise-options');
                    optionsDiv.innerHTML = '';

                    if (q.options) {
                        q.options.forEach((opt, idx) => {
                            optionsDiv.innerHTML += `
                        <div class="exercise-option" onclick="selectExerciseOption(${idx})" 
                             style="padding: 10px; border: 1px solid var(--card-border); margin: 5px 0; cursor: pointer; border-radius: 8px;">
                            ${opt}
                        </div>`;
                        });
                    } else {
                        optionsDiv.innerHTML = `
                    <div class="exercise-option" onclick="selectExerciseOption(true)" 
                         style="padding: 10px; border: 1px solid var(--card-border); margin: 5px 0; cursor: pointer; border-radius: 8px;">Verdadero / S√≠</div>
                    <div class="exercise-option" onclick="selectExerciseOption(false)" 
                         style="padding: 10px; border: 1px solid var(--card-border); margin: 5px 0; cursor: pointer; border-radius: 8px;">Falso / No</div>
                `;
                    }

                    document.getElementById('exercise-counter').textContent = `${state.exerciseProgress + 1}/${state.currentExercise.questions.length}`;
                    const progressPct = ((state.exerciseProgress) / state.currentExercise.questions.length) * 100;
                    document.getElementById('exercise-progress').style.width = `${progressPct}%`;
                }

                let selectedAnswer = null;
                function selectExerciseOption(val) {
                    selectedAnswer = val;
                    document.querySelectorAll('.exercise-option').forEach(el => el.style.borderColor = 'var(--card-border)');
                    event.target.style.borderColor = 'var(--accent)';
                }

                function submitExerciseAnswer() {
                    if (selectedAnswer === null) return;

                    const q = state.currentExercise.questions[state.exerciseProgress];
                    const isCorrect = selectedAnswer === q.correct;

                    state.exerciseAnswers.push({
                        question: q.question,
                        answer: selectedAnswer,
                        correct: isCorrect
                    });

                    if (isCorrect) {
                        showNotification('¬°Correcto! +10 Tokens', 'success');
                        state.userTokens += 10;
                        const tokenEl = document.getElementById('sidebar-token-count');
                        if (tokenEl) tokenEl.textContent = state.userTokens.toLocaleString();
                    } else {
                        showNotification('Incorrecto', 'error');
                    }

                    state.exerciseProgress++;
                    selectedAnswer = null;
                    showExerciseQuestion();
                }

                function finishExercise() {
                    document.getElementById('current-exercise').style.display = 'none';
                    showNotification('Ejercicio completado', 'success');
                }

                // ==========================================
                // RAG LOGIC
                // ==========================================
                async function loadRagDocuments() {
                    if (!state.backendOnline) return;
                    try {
                        const response = await fetch(`${API_BASE}/api/rag/documents`);
                        if (response.ok) {
                            const data = await response.json();
                            const list = document.getElementById('rag-documents-list');
                            if (data.documents && data.documents.length > 0) {
                                list.innerHTML = data.documents.map(d => `
                            <div style="padding: 10px; border-bottom: 1px solid var(--card-border); display: flex; justify-content: space-between;">
                                <span>${d.filename}</span>
                                <span style="color: var(--muted);">${d.size}</span>
                            </div>
                        `).join('');
                            } else {
                                list.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 20px;">No hay documentos</p>';
                            }
                        }
                    } catch (e) { console.error(e); }
                }

                async function uploadRagDocument() {
                    const input = document.getElementById('rag-file-input');
                    if (input.files.length > 0) {
                        const formData = new FormData();
                        formData.append('file', input.files[0]);

                        try {
                            const response = await fetch(`${API_BASE}/api/rag/upload`, {
                                method: 'POST',
                                body: formData
                            });
                            if (response.ok) {
                                showNotification('Documento subido', 'success');
                                loadRagDocuments();
                            } else {
                                showNotification('Error al subir', 'error');
                            }
                        } catch (e) {
                            showNotification('Error de conexi√≥n', 'error');
                        }
                    }
                }

                // ==========================================
                // CORPUS PRO & ANALYTICS & BLOCKCHAIN
                // ==========================================
                async function loadCorpusInfo() {
                    if (!state.backendOnline) return;
                    try {
                        const response = await fetch(`${API_BASE}/api/corpus/info`);
                        if (response.ok) {
                            const data = await response.json();
                            document.getElementById('corpus-total-docs').textContent = data.total_documents || 0;
                            document.getElementById('corpus-total-chunks').textContent = data.total_chunks || 0;
                            document.getElementById('corpus-avg-chunk-size').textContent = (data.avg_chunk_size || 0) + ' chars';
                            showNotification('‚úÖ Info del corpus cargada', 'success');
                        }
                    } catch (e) {
                        console.error(e);
                        showNotification('‚ùå Error cargando corpus info', 'error');
                    }
                }
                function loadCorpusMetrics() { }
                async function ingestFolder() {
                    const folderPath = document.getElementById('folder-path-input')?.value;
                    if (!folderPath) {
                        showNotification('‚ùå Por favor ingresa una ruta de carpeta', 'warning');
                        return;
                    }
                    if (!state.backendOnline) return;
                    try {
                        showNotification('üîÑ Ingiriendo carpeta...', 'info');
                        const response = await fetch(`${API_BASE}/api/corpus/ingest`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ folder_path: folderPath })
                        });
                        if (response.ok) {
                            const data = await response.json();
                            showNotification(`‚úÖ ${data.files_processed || 0} archivos procesados`, 'success');
                            loadCorpusInfo();
                        } else {
                            showNotification('‚ùå Error en la ingesta', 'error');
                        }
                    } catch (e) {
                        console.error(e);
                        showNotification('‚ùå Error al ingerir carpeta', 'error');
                    }
                }
                async function runFullPipeline() {
                    if (!state.backendOnline) return;
                    if (!confirm('¬øEjecutar pipeline completo? Esto puede tomar varios minutos.')) return;
                    try {
                        showNotification('üîÑ Ejecutando pipeline completo...', 'info');
                        const response = await fetch(`${API_BASE}/api/corpus/pipeline`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ full_rebuild: true })
                        });
                        if (response.ok) {
                            const data = await response.json();
                            showNotification(`‚úÖ Pipeline completado: ${data.status}`, 'success');
                            loadCorpusInfo();
                        } else {
                            showNotification('‚ùå Error en pipeline', 'error');
                        }
                    } catch (e) {
                        console.error(e);
                        showNotification('‚ùå Error ejecutando pipeline', 'error');
                    }
                }
                async function advancedSearch() {
                    const query = document.getElementById('corpus-search-input')?.value;
                    if (!query) {
                        showNotification('‚ùå Ingresa una consulta de b√∫squeda', 'warning');
                        return;
                    }
                    if (!state.backendOnline) return;
                    try {
                        showNotification('üîç Buscando en corpus...', 'info');
                        const response = await fetch(`${API_BASE}/api/rag/search`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ query: query, top_k: 5 })
                        });
                        if (response.ok) {
                            const data = await response.json();
                            const resultsDiv = document.getElementById('corpus-search-results');
                            if (data.results && data.results.length > 0) {
                                resultsDiv.innerHTML = data.results.map(r => `
                                    <div style="padding: 10px; border-bottom: 1px solid var(--card-border); margin-bottom: 10px;">
                                        <div style="font-weight: 600; color: var(--accent); margin-bottom: 5px;">Score: ${(r.score || 0).toFixed(3)}</div>
                                        <div style="color: var(--fg); margin-bottom: 5px;">${r.text || r.content}</div>
                                        <div style="font-size: 0.8rem; color: var(--muted);">Fuente: ${r.source || 'N/A'}</div>
                                    </div>
                                `).join('');
                                showNotification(`‚úÖ ${data.results.length} resultados encontrados`, 'success');
                            } else {
                                resultsDiv.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 20px;">No se encontraron resultados</p>';
                                showNotification('‚ÑπÔ∏è Sin resultados', 'info');
                            }
                        } else {
                            showNotification('‚ùå Error en b√∫squeda', 'error');
                        }
                    } catch (e) {
                        console.error(e);
                        showNotification('‚ùå Error buscando en corpus', 'error');
                    }
                }
                async function createSnapshot() {
                    const name = prompt('¬øNombre del snapshot?');
                    if (!name) return;
                    if (!state.backendOnline) return;
                    try {
                        const response = await fetch(`${API_BASE}/api/corpus/snapshot/create`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: name })
                        });
                        if (response.ok) {
                            showNotification('‚úÖ Snapshot creado exitosamente', 'success');
                            loadSnapshots();
                        }
                    } catch (e) { console.error(e); }
                }
                async function loadSnapshots() {
                    if (!state.backendOnline) return;
                    try {
                        const response = await fetch(`${API_BASE}/api/corpus/snapshots`);
                        if (response.ok) {
                            const data = await response.json();
                            const list = document.getElementById('snapshots-list');
                            if (list && data.snapshots) {
                                list.innerHTML = data.snapshots.map(s => `<div>${s.name} - ${s.date}</div>`).join('');
                            }
                        }
                    } catch (e) { console.error(e); }
                }
                async function runDoctor() {
                    if (!state.backendOnline) return;
                    try {
                        showNotification('üë®‚Äç‚öïÔ∏è Ejecutando diagn√≥stico...', 'info');
                        const response = await fetch(`${API_BASE}/api/corpus/doctor`, {
                            method: 'POST'
                        });
                        if (response.ok) {
                            const data = await response.json();
                            showNotification(`‚úÖ Diagn√≥stico completo: ${data.status}`, 'success');
                        }
                    } catch (e) { console.error(e); }
                }

                async function loadAnalyticsData() {
                    if (!state.backendOnline) return;
                    try {
                        const response = await fetch(`${API_BASE}/api/stats`);
                        if (response.ok) {
                            const data = await response.json();
                            document.getElementById('avg-latency').textContent = (data.latency || '--') + 'ms';
                            document.getElementById('throughput').textContent = (data.throughput || '--') + ' req/s';
                        }
                    } catch (e) { }
                }

                async function checkBalance() {
                    loadUserTokens();
                    showNotification('Balance actualizado', 'success');
                }

                // ==========================================
                // UTILS
                // ==========================================
                function showNotification(msg, type) {
                    const toast = document.createElement('div');
                    toast.textContent = msg;
                    toast.style.position = 'fixed';
                    toast.style.bottom = '20px';
                    toast.style.right = '20px';
                    toast.style.padding = '12px 24px';
                    toast.style.borderRadius = '8px';
                    toast.style.color = '#fff';
                    toast.style.zIndex = '1000';
                    toast.style.animation = 'slideIn 0.3s ease';

                    if (type === 'success') toast.style.background = 'rgba(16, 185, 129, 0.9)';
                    else if (type === 'error') toast.style.background = 'rgba(239, 68, 68, 0.9)';
                    else toast.style.background = 'rgba(59, 130, 246, 0.9)';

                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }

                function toggleSidebar() {
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar) sidebar.classList.toggle('open');
                }

                // ==========================================
                // CHAT LOGIC
                // ==========================================
                function toggleReflexionMode() {
                    state.reflexionMode = document.getElementById('reflexionToggle').checked;
                    showNotification(`Modo Reflexi√≥n: ${state.reflexionMode ? 'ON' : 'OFF'}`, 'info');
                }

                function toggleSearchMode() {
                    state.searchMode = document.getElementById('searchToggle').checked;
                    showNotification(`B√∫squeda Web: ${state.searchMode ? 'ON' : 'OFF'}`, 'info');
                }

                function autoResize(textarea) {
                    textarea.style.height = 'auto';
                    textarea.style.height = textarea.scrollHeight + 'px';
                }

                function handleKeyDown(event) {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        sendMessage();
                    }
                }

                function sendQuickMessage(text) {
                    document.getElementById('messageInput').value = text;
                    sendMessage();
                }

                async function sendMessage() {
                    const input = document.getElementById('messageInput');
                    const text = input.value.trim();
                    if (!text) return;

                    // UI Update
                    addMessageToUI(text, 'user');
                    input.value = '';
                    input.style.height = 'auto';

                    // Hide welcome if first message
                    const welcome = document.getElementById('welcomeSection');
                    if (welcome) welcome.style.display = 'none';

                    // Show typing
                    const typing = document.getElementById('typingIndicator');
                    typing.style.display = 'flex';
                    state.isTyping = true;

                    try {
                        // Prepare payload
                        const payload = {
                            message: text,
                            reflexion: state.reflexionMode,
                            web_search: state.searchMode
                        };

                        const response = await fetch(`${API_BASE}/api/chat/send`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const data = await response.json();
                            typing.style.display = 'none';

                            // Handle both response formats (simple dict or ChatResponse model)
                            const aiText = data.response || (data.message && data.message.content) || "Error: No response content";
                            addMessageToUI(aiText, 'ai');

                            // Update tokens if provided
                            if (data.tokens_used) {
                                state.userTokens -= data.tokens_used;
                                const tokenEl = document.getElementById('sidebar-token-count');
                                if (tokenEl) tokenEl.textContent = state.userTokens.toLocaleString();
                            }
                        } else {
                            throw new Error('Server error');
                        }
                    } catch (error) {
                        typing.style.display = 'none';
                        addMessageToUI('Lo siento, hubo un error de conexi√≥n. Intenta de nuevo.', 'ai');
                        console.error(error);
                    }
                    state.isTyping = false;
                }

                function addMessageToUI(text, sender) {
                    const container = document.getElementById('messages');
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `message ${sender}`;

                    const avatar = sender === 'user' ? 'üë§' : 'üß†';
                    const name = sender === 'user' ? 'T√∫' : 'SHEILY';

                    // Parse markdown if available
                    const htmlContent = (typeof marked !== 'undefined') ? marked.parse(text) : text;

                    msgDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">${name}</span>
                        <span class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                    </div>
                    <div class="message-bubble">${htmlContent}</div>
                </div>
            `;

                    container.appendChild(msgDiv);
                    container.scrollTop = container.scrollHeight;

                    // Scroll chat container too
                    const chatContainer = document.getElementById('chatContainer');
                    if (chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
                }

                // Initial checks
                document.addEventListener('DOMContentLoaded', () => {
                    // Check backend health
                    fetch(`${API_BASE}/api/health`)
                        .then(r => {
                            if (r.ok) {
                                state.backendOnline = true;
                                showNotification('Backend conectado', 'success');
                                loadUserTokens();
                            } else {
                                showNotification('Backend offline', 'error');
                            }
                        })
                        .catch(() => showNotification('Backend offline', 'error'));
                });

                // ==========================================
                // EXERCISE SYSTEM FUNCTIONS
                // ==========================================

                function startExercise(type) {
                    if (GameData.currentExercise) {
                        showNotification('Completa el ejercicio actual primero.', 'warning');
                        return;
                    }

                    GameData.currentExercise = {
                        type: type,
                        questions: [...GameData.questions[type]],
                        currentIndex: 0,
                        answers: [],
                        correctCount: 0,
                        startTime: Date.now()
                    };

                    renderCurrentExercise();
                }

                function renderCurrentExercise() {
                    const currentEx = document.getElementById('current-exercise');
                    const questionEl = document.getElementById('exercise-question');
                    const optionsEl = document.getElementById('exercise-options');
                    const progressBar = document.getElementById('exercise-progress');
                    const counter = document.getElementById('exercise-counter');

                    if (!GameData.currentExercise) {
                        currentEx.style.display = 'none';
                        return;
                    }

                    currentEx.style.display = 'block';
                    const exercise = GameData.currentExercise;
                    const question = exercise.questions[exercise.currentIndex];
                    const progress = ((exercise.currentIndex + 1) / exercise.questions.length) * 100;

                    questionEl.innerHTML = `Pregunta ${exercise.currentIndex + 1} de ${exercise.questions.length}:<br><strong>${question.q}</strong>`;
                    progressBar.style.width = progress + '%';
                    counter.textContent = `${exercise.currentIndex + 1}/20`;

                    let optionsHTML = '';
                    if (exercise.type === 'multiple') {
                        optionsHTML = question.o.map((option, index) =>
                            `<button class="btn" onclick="submitExerciseAnswer(${index})" style="margin: 5px;">${option}</button>`
                        ).join('');
                    } else {
                        const affirmative = exercise.type === 'yesno' ? '‚úÖ S√≠' : '‚úì Verdadero';
                        const negative = exercise.type === 'yesno' ? '‚ùå No' : '‚úó Falso';
                        optionsHTML = `
                                <button class="btn" onclick="submitExerciseAnswer(true)" style="margin: 5px;">${affirmative}</button>
                                <button class="btn" onclick="submitExerciseAnswer(false)" style="margin: 5px;">${negative}</button>
                            `;
                    }

                    optionsEl.innerHTML = optionsHTML;
                }

                function submitExerciseAnswer(answer) {
                    const exercise = GameData.currentExercise;
                    if (!exercise) return;

                    const question = exercise.questions[exercise.currentIndex];
                    const isCorrect = answer === question.a;

                    if (isCorrect) {
                        GameData.balance += 3;
                        exercise.correctCount++;
                        GameData.claimsVerified++;
                        showNotification('‚úÖ ¬°Correcto! +3 tokens', 'success');
                    } else {
                        GameData.balance -= 1;
                        showNotification('‚ùå Incorrecto. -1 token', 'error');
                    }

                    exercise.answers.push({
                        question: question.q,
                        userAnswer: answer,
                        correctAnswer: question.a,
                        isCorrect: isCorrect,
                        timestamp: new Date().toISOString()
                    });

                    exercise.currentIndex++;

                    if (exercise.currentIndex >= exercise.questions.length) {
                        finishExercise();
                    } else {
                        renderCurrentExercise();
                    }

                    GameData.save();
                }

                function finishExercise() {
                    const exercise = GameData.currentExercise;
                    const accuracy = (exercise.correctCount / exercise.questions.length) * 100;

                    // Create dataset
                    const dataset = {
                        id: Date.now(),
                        name: `Dataset ${exercise.type} - ${new Date().toLocaleDateString()}`,
                        type: exercise.type,
                        questions: exercise.answers.length,
                        correct: exercise.correctCount,
                        incorrect: exercise.answers.length - exercise.correctCount,
                        accuracy: accuracy,
                        timestamp: new Date().toISOString(),
                        data: exercise.answers
                    };

                    GameData.datasets.push(dataset);
                    GameData.exercisesCompleted++;
                    GameData.currentExercise = null;

                    showNotification(`‚úÖ Ejercicio completado! Precisi√≥n: ${accuracy.toFixed(1)}%. Dataset generado.`, 'success');

                    document.getElementById('current-exercise').style.display = 'none';
                    GameData.save();
                }

                // ==========================================
                // MARKETPLACE FUNCTIONS
                // ==========================================

                function renderProductsInMarketplace() {
                    const container = document.getElementById('marketplace-products');
                    if (!container) return;

                    const productsHTML = GameData.products.map(product => {
                        const isOwned = product.owned || GameData.ownedServices.includes(product.id);
                        return `
                                <div class="card" style="cursor: pointer; ${isOwned ? 'opacity: 0.7;' : ''}">
                                    ${isOwned ? '<div style="position: absolute; top: 10px; right: 10px; background: #22c55e; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem;">‚úì ACTIVO</div>' : ''}
                                    <div style="font-size: 2rem; margin-bottom: 10px;">${product.name.split(' ')[0]}</div>
                                    <h4 style="margin-bottom: 10px; color: ${isOwned ? '#22c55e' : 'var(--accent)'};">${product.name.substring(3)}</h4>
                                    <p style="color: var(--muted); margin-bottom: 15px; font-size: 0.9rem;">${product.description}</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: var(--accent); font-weight: bold; font-size: 1.1rem;">${product.price} tokens</span>
                                        ${isOwned ?
                                '<span style="color: #22c55e; font-weight: bold;">‚úì En uso</span>' :
                                `<button class="btn" onclick="buyProductFromMarketplace('${product.id}', ${product.price})" style="padding: 8px 16px; font-size: 0.9rem;">Comprar</button>`
                            }
                                    </div>
                                </div>
                            `;
                    }).join('');

                    container.innerHTML = productsHTML;
                }

                function buyProductFromMarketplace(productId, price) {
                    const product = GameData.products.find(p => p.id === productId);
                    if (!product) return;

                    if (GameData.balance < price) {
                        showNotification(`Necesitas ${price} tokens. Tu balance: ${GameData.balance}`, 'error');
                        return;
                    }

                    if (confirm(`¬øComprar ${product.name} por ${price} tokens?`)) {
                        GameData.balance -= price;
                        GameData.ownedServices.push(productId);
                        product.owned = true;

                        showNotification(`¬°${product.name} comprado exitosamente!`, 'success');
                        renderProductsInMarketplace();
                        GameData.save();
                    }
                }

                // ==========================================
                // NOTIFICATION SYSTEM
                // ==========================================

                function showNotification(message, type = 'info') {
                    const container = document.getElementById('notifications-container') || createNotificationsContainer();
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                            padding: 15px 20px;
                            margin-bottom: 10px;
                            border-radius: 8px;
                            background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
                            color: white;
                            font-weight: 500;
                            animation: slideInRight 0.3s ease-out;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        `;
                    notification.textContent = message;

                    container.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);
                }

                function createNotificationsContainer() {
                    const container = document.createElement('div');
                    container.id = 'notifications-container';
                    container.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            z-index: 10000;
                            max-width: 350px;
                        `;
                    document.body.appendChild(container);
                    return container;
                }

                // ==========================================
                // NEW TABS FUNCTIONS
                // ==========================================

                // Tokens Tab
                async function loadTokensDetails() {
                    if (!state.backendOnline) return;
                    try {
                        const response = await fetch(`${API_BASE}/api/user/tokens`);
                        if (response.ok) {
                            const data = await response.json();
                            document.getElementById('tokens-balance').textContent = data.balance || 0;
                            document.getElementById('tokens-level').textContent = data.level || 1;
                            document.getElementById('tokens-earned').textContent = data.total_earned || 0;

                            // Load transaction history if available
                            if (data.history && data.history.length > 0) {
                                const historyHTML = data.history.map(tx => `
                                        <div style="padding: 10px; border-bottom: 1px solid var(--card-border);">
                                            <div style="display: flex; justify-content: space-between;">
                                                <span>${tx.description}</span>
                                                <span style="color: ${tx.amount > 0 ? '#22c55e' : '#ef4444'}; font-weight: bold;">
                                                    ${tx.amount > 0 ? '+' : ''}${tx.amount}
                                                </span>
                                            </div>
                                            <div style="font-size: 0.8rem; color: var(--muted);">
                                                ${new Date(tx.timestamp).toLocaleString()}
                                            </div>
                                        </div>
                                    `).join('');
                                document.getElementById('token-history').innerHTML = historyHTML;
                            }
                        }
                    } catch (error) {
                        console.error('Error loading tokens details:', error);
                    }
                }

                // Training Stats Tab
                async function loadTrainingStats() {
                    if (!state.backendOnline) return;
                    try {
                        const response = await fetch(`${API_BASE}/api/stats/training`);
                        if (response.ok) {
                            const data = await response.json();
                            document.getElementById('stats-exercises').textContent = data.exercises_completed || 0;
                            document.getElementById('stats-datasets').textContent = data.datasets_generated || 0;
                            document.getElementById('stats-accuracy').textContent = (data.avg_accuracy || 0).toFixed(1) + '%';
                            document.getElementById('stats-claims').textContent = data.claims_verified || 0;

                            // Draw simple progress chart if canvas is available
                            drawProgressChart(data.progress || []);
                        }
                    } catch (error) {
                        console.error('Error loading training stats:', error);
                    }
                }

                function drawProgressChart(progressData) {
                    const canvas = document.getElementById('progress-canvas');
                    if (!canvas) return;

                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    if (progressData.length === 0) {
                        ctx.fillStyle = '#94a3b8';
                        ctx.font = '14px Inter';
                        ctx.textAlign = 'center';
                        ctx.fillText('No hay datos de progreso a√∫n', canvas.width / 2, canvas.height / 2);
                        return;
                    }

                    // Simple line chart
                    ctx.strokeStyle = '#00f0ff';
                    ctx.lineWidth = 2;
                    ctx.beginPath();

                    const stepX = canvas.width / (progressData.length - 1 || 1);
                    progressData.forEach((val, i) => {
                        const x = i * stepX;
                        const y = canvas.height - (val * canvas.height);
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    });
                    ctx.stroke();
                }

                // Marketplace Tab
                const marketplaceProducts = [
                    { id: 'agent-premium', name: 'ü§ñ Agente Premium', description: 'Acceso a agentes especializados avanzados', price: 500 },
                    { id: 'rag-pro', name: 'üìö RAG Pro', description: 'Sistema RAG con capacidades enterprise', price: 750 },
                    { id: 'analytics-full', name: 'üìä Analytics Full', description: 'Dashboard de analytics completo', price: 300 },
                    { id: 'corpus-unlimited', name: 'üî¨ Corpus Unlimited', description: 'Sin l√≠mite de documentos en corpus', price: 1000 },
                    { id: 'export-tools', name: 'üîÑ Export Tools', description: 'Exporta tus datos y modelos', price: 200 },
                    { id: 'api-access', name: 'üîó API Access', description: 'Acceso completo a la API', price: 600 }
                ];

                function loadMarketplace() {
                    const container = document.getElementById('marketplace-products');
                    if (!container) return;

                    const productsHTML = marketplaceProducts.map(product => `
                            <div class="card" style="cursor: pointer; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="font-size: 2rem; margin-bottom: 10px;">${product.name.split(' ')[0]}</div>
                                <h4 style="margin-bottom: 10px; color: var(--accent);">${product.name.substring(3)}</h4>
                                <p style="color: var(--muted); margin-bottom: 15px; font-size: 0.9rem;">${product.description}</p>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: var(--accent); font-weight: bold; font-size: 1.1rem;">${product.price} tokens</span>
                                    <button class="btn" onclick="buyProduct('${product.id}', ${product.price})" style="padding: 8px 16px; font-size: 0.9rem;">
                                        Comprar
                                    </button>
                                </div>
                            </div>
                        `).join('');

                    container.innerHTML = productsHTML;
                }

                function buyProduct(productId, price) {
                    if (state.userTokens < price) {
                        showNotification(`Necesitas ${price} tokens. Tu balance: ${state.userTokens}`, 'error');
                        return;
                    }

                    if (confirm(`¬øComprar ${productId} por ${price} tokens?`)) {
                        state.userTokens -= price;
                        document.getElementById('sidebar-token-count').textContent = state.userTokens.toLocaleString();
                        showNotification(`¬°${productId} comprado exitosamente!`, 'success');
                    }
                }

                // Consciousness Tab
                async function loadConsciousness() {
                    if (!state.backendOnline) {
                        showNotification('Backend offline, no se puede cargar consciencia', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${API_BASE}/api/v1/consciousness/status`);
                        if (response.ok) {
                            const data = await response.json();

                            // Update status displays
                            document.getElementById('cons-level').textContent = data.status || 'UNKNOWN';
                            document.getElementById('cons-score').textContent = ((data.awareness_level || 0) * 100).toFixed(1) + '%';
                            document.getElementById('cons-emotion').textContent = data.emotional_state || 'Neutral';
                            document.getElementById('cons-load').textContent = ((data.cognitive_load || 0) * 100).toFixed(1) + '%';
                            document.getElementById('last-thought').textContent = data.last_thought || 'Sin pensamientos recientes...';

                            // Get metrics if available
                            const metricsRes = await fetch(`${API_BASE}/api/v1/consciousness/metrics`);
                            if (metricsRes.ok) {
                                const metrics = await metricsRes.json();
                                document.getElementById('total-memories').textContent = metrics.total_memories || 0;
                                document.getElementById('learning-exps').textContent = metrics.learning_experiences || 0;
                                document.getElementById('avg-quality').textContent = (metrics.average_quality || 0).toFixed(2);
                            }

                            showNotification('Estado de consciencia actualizado', 'success');
                        }
                    } catch (error) {
                        console.error('Error loading consciousness:', error);
                        showNotification('Error cargando consciencia', 'error');

                        // Fallback display
                        document.getElementById('cons-level').textContent = 'ERROR';
                        document.getElementById('cons-score').textContent = '--';
                        document.getElementById('cons-emotion').textContent = 'Desconocido';
                        document.getElementById('cons-load').textContent = '--';
                    }
                }

                // Update switchTab to load new tabs
                const originalSwitchTab = switchTab;
                switchTab = function (tabId) {
                    originalSwitchTab(tabId);

                    // Load specific tab content
                    if (tabId === 'tokens') loadTokensDetails();
                    if (tabId === 'training-stats') loadTrainingStats();
                    if (tabId === 'marketplace') {
                        loadMarketplace();
                        renderProductsInMarketplace(); // Also render offline products
                    }
                    if (tabId === 'consciousness') loadConsciousness();
                };

                // Torus Animation (Simplified)
                const canvas = document.getElementById('torusCanvas');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    let t = 0;
                    function draw() {
                        ctx.clearRect(0, 0, 120, 120);
                        ctx.strokeStyle = 'rgba(0, 240, 255, 0.5)';
                        ctx.beginPath();
                        ctx.arc(60, 60, 20 + Math.sin(t) * 5, 0, Math.PI * 2);
                        ctx.stroke();
                        t += 0.05;
                        requestAnimationFrame(draw);
                    }
                    draw();
                }
            </script>
</body>

</html>