<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üß† Sheily AI - Dashboard Funcional</title>
  <meta name="description" content="Dashboard funcional de Sheily AI con chat, ejercicios y analytics">
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß†</text></svg>">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a0c14 0%, #0f1419 50%, #0a0c14 100%);
      color: #f1f5f9;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo {
      font-size: 2.5rem;
      font-weight: bold;
      background: linear-gradient(45deg, #3b82f6, #06b6d4, #8b5cf6);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #94a3b8;
      font-size: 1.1rem;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      border-color: rgba(59, 130, 246, 0.3);
      box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #10b981;
    }

    .status-indicator.offline {
      background: #ef4444;
    }

    .metric {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 0.9rem;
    }

    .metric-value {
      font-weight: bold;
      color: #3b82f6;
    }

    .btn {
      background: linear-gradient(45deg, #3b82f6, #06b6d4);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
    }

    .chat-container {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .chat-messages {
      margin-bottom: 15px;
      max-height: 250px;
      overflow-y: auto;
    }

    .message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 8px;
      max-width: 80%;
    }

    .message.user {
      background: rgba(59, 130, 246, 0.2);
      margin-left: auto;
      text-align: right;
    }

    .message.ai {
      background: rgba(255, 255, 255, 0.1);
    }

    .chat-input {
      display: flex;
      gap: 10px;
    }

    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      color: white;
    }

    .chat-input input::placeholder {
      color: #94a3b8;
    }

    .exercise-section {
      margin-top: 20px;
    }

    .exercise-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
    }

    .exercise-question {
      margin-bottom: 15px;
      font-size: 1.1rem;
    }

    .exercise-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .exercise-option {
      padding: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .exercise-option:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .exercise-option.selected {
      background: rgba(59, 130, 246, 0.2);
      border-color: #3b82f6;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(45deg, #3b82f6, #06b6d4);
      width: 0%;
      transition: width 0.3s ease;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    .notification.success {
      background: rgba(16, 185, 129, 0.9);
    }

    .notification.error {
      background: rgba(239, 68, 68, 0.9);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .tab.active {
      border-bottom-color: #3b82f6;
      color: #3b82f6;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="logo">üß† Sheily AI Dashboard</div>
      <div class="subtitle">Sistema de IA Unificado - Dashboard Funcional</div>
    </div>

    <!-- Estado del Sistema -->
    <div class="dashboard-grid">
      <div class="card">
        <div class="card-title">
          <div class="status-indicator" id="backend-status"></div>
          Estado del Backend
        </div>
        <div class="metric">
          <span>Conexi√≥n:</span>
          <span class="metric-value" id="connection-status">Verificando...</span>
        </div>
        <div class="metric">
          <span>Latencia:</span>
          <span class="metric-value" id="latency">--ms</span>
        </div>
        <button class="btn" onclick="checkBackendHealth()">Verificar Conexi√≥n</button>
      </div>

      <div class="card">
        <div class="card-title">üí∞ Tokens del Usuario</div>
        <div class="metric">
          <span>Balance:</span>
          <span class="metric-value" id="token-balance">0</span>
        </div>
        <div class="metric">
          <span>Nivel:</span>
          <span class="metric-value" id="user-level">1</span>
        </div>
        <button class="btn" onclick="loadUserTokens()">Actualizar Tokens</button>
      </div>

      <div class="card">
        <div class="card-title">üìä Estad√≠sticas del Sistema</div>
        <div class="metric">
          <span>Usuarios:</span>
          <span class="metric-value" id="total-users">--</span>
        </div>
        <div class="metric">
          <span>Conversaciones:</span>
          <span class="metric-value" id="total-conversations">--</span>
        </div>
        <button class="btn" onclick="loadSystemStats()">Cargar Estad√≠sticas</button>
      </div>
    </div>

    <!-- Pesta√±as del Dashboard -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('chat')">üí¨ Chat IA</div>
      <div class="tab" onclick="switchTab('exercises')">üéØ Ejercicios</div>
      <div class="tab" onclick="switchTab('datasets')">üìä Datasets</div>
      <div class="tab" onclick="switchTab('rag')">üìö RAG Manager</div>
      <div class="tab" onclick="switchTab('corpus-pro')">üî¨ Corpus Pro</div>
      <div class="tab" onclick="switchTab('analytics')">ÔøΩ Analytics</div>
      <div class="tab" onclick="switchTab('blockchain')">‚õìÔ∏è Blockchain</div>
    </div>

    <!-- Contenido de las pesta√±as -->
    <div id="chat-tab" class="tab-content active">
      <div class="card">
        <div class="card-title">üß† Chat con Sheily AI</div>
        <div class="chat-container">
          <div class="chat-messages" id="chat-messages">
            <div class="message ai">
              ¬°Hola! Soy Sheily AI. ¬øEn qu√© puedo ayudarte hoy?
            </div>
          </div>
          <div class="chat-input">
            <input type="text" id="chat-input" placeholder="Escribe tu mensaje..."
              onkeypress="handleChatKeyPress(event)">
            <button class="btn" onclick="sendMessage()" style="width: auto; padding: 10px 15px;">Enviar</button>
          </div>
        </div>
      </div>
    </div>

    <div id="exercises-tab" class="tab-content">
      <div class="card">
        <div class="card-title">üéØ Ejercicios de Entrenamiento</div>
        <div class="exercise-section">
          <div class="exercise-card" id="current-exercise" style="display: none;">
            <div class="exercise-question" id="exercise-question"></div>
            <div class="exercise-options" id="exercise-options"></div>
            <button class="btn" onclick="submitExerciseAnswer()" style="margin-top: 15px;">Enviar Respuesta</button>
          </div>

          <div class="exercise-types">
            <button class="btn" onclick="startExercise('yesno')" style="margin: 5px;">Preguntas S√≠/No</button>
            <button class="btn" onclick="startExercise('truefalse')" style="margin: 5px;">Verdadero/Falso</button>
            <button class="btn" onclick="startExercise('multiple')" style="margin: 5px;">Opci√≥n M√∫ltiple</button>
          </div>

          <div class="progress-bar">
            <div class="progress-fill" id="exercise-progress"></div>
          </div>
          <div style="text-align: center; margin-top: 10px; color: #94a3b8;">
            Progreso: <span id="exercise-counter">0/20</span>
          </div>
        </div>
      </div>
    </div>

    <div id="analytics-tab" class="tab-content">
      <div class="dashboard-grid">
        <div class="card">
          <div class="card-title">üéØ Rendimiento del Sistema</div>
          <div class="metric">
            <span>Latencia Promedio:</span>
            <span class="metric-value" id="avg-latency">--ms</span>
          </div>
          <div class="metric">
            <span>Throughput:</span>
            <span class="metric-value" id="throughput">-- req/s</span>
          </div>
          <div class="metric">
            <span>Disponibilidad:</span>
            <span class="metric-value" id="availability">--%</span>
          </div>
        </div>

        <div class="card">
          <div class="card-title">üë• Actividad de Usuarios</div>
          <div class="metric">
            <span>Usuarios Activos:</span>
            <span class="metric-value" id="active-users">--</span>
          </div>
          <div class="metric">
            <span>Conversaciones Hoy:</span>
            <span class="metric-value" id="conversations-today">--</span>
          </div>
          <div class="metric">
            <span>Ejercicios Completados:</span>
            <span class="metric-value" id="exercises-completed">--</span>
          </div>
        </div>
      </div>
    </div>

    <div id="blockchain-tab" class="tab-content">
      <div class="dashboard-grid">
        <div class="card">
          <div class="card-title">üí∞ Balance de SHEILY</div>
          <div class="metric">
            <span>Tokens Disponibles:</span>
            <span class="metric-value" id="sheily-balance">0.00</span>
          </div>
          <div class="metric">
            <span>Valor USD:</span>
            <span class="metric-value" id="sheily-usd">$0.00</span>
          </div>
          <div class="metric">
            <span>Transacciones:</span>
            <span class="metric-value" id="transaction-count">0</span>
          </div>
        </div>

        <div class="card">
          <div class="card-title">üè¶ Operaciones Blockchain</div>
          <button class="btn" onclick="sendTokens()" style="margin: 5px;">Enviar Tokens</button>
          <button class="btn" onclick="receiveTokens()" style="margin: 5px;">Recibir Tokens</button>
          <button class="btn" onclick="checkBalance()" style="margin: 5px;">Actualizar Balance</button>
        </div>
      </div>
    </div>

    <div id="corpus-pro-tab" class="tab-content">
      <div class="card">
        <div class="card-title">üî¨ Corpus Pro - Herramientas Avanzadas RAG</div>
        <p style="color: #94a3b8; margin-bottom: 20px;">
          Sistema profesional con 40+ herramientas para procesamiento avanzado de documentos
        </p>
      </div>

      <!-- Secci√≥n 1: Info del Corpus -->
      <div class="card">
        <div class="card-title">üìä Informaci√≥n del Corpus</div>
        <div class="metric">
          <span>Snapshot Activo:</span>
          <span class="metric-value" id="corpus-snapshot">--</span>
        </div>
        <div class="metric">
          <span>Documentos Raw:</span>
          <span class="metric-value" id="corpus-raw-docs">0</span>
        </div>
        <div class="metric">
          <span>Chunks Procesados:</span>
          <span class="metric-value" id="corpus-chunks">0</span>
        </div>
        <div class="metric">
          <span>Embeddings:</span>
          <span class="metric-value" id="corpus-embeddings">0</span>
        </div>
        <div style="margin-top: 15px;">
          <strong>√çndices Disponibles:</strong>
          <div id="corpus-indices" style="margin-top: 8px; color: #94a3b8;"></div>
        </div>
        <button class="btn" onclick="loadCorpusInfo()">üîÑ Actualizar Info</button>
      </div>

      <!-- Secci√≥n 2: Ingesta Profesional -->
      <div class="card">
        <div class="card-title">üì• Ingesta Profesional</div>
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 8px; color: #94a3b8;">
            Carpeta de Origen:
            <input type="text" id="ingest-folder" placeholder="C:\ruta\a\documentos"
              style="width: 100%; padding: 8px; margin-top: 5px; background: #1e293b; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;">
          </label>
          <label style="display: inline-block; margin-right: 15px; color: #94a3b8;">
            <input type="checkbox" id="enable-ocr"> Activar OCR
          </label>
          <label style="display: inline-block; color: #94a3b8;">
            Workers: <input type="number" id="workers" value="6" min="1" max="12"
              style="width: 60px; padding: 5px; background: #1e293b; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;">
          </label>
        </div>
        <button class="btn" onclick="ingestFolder()">üì• Iniciar Ingesta</button>
        <div id="ingest-output"
          style="margin-top: 15px; padding: 10px; background: #0f172a; border-radius: 4px; font-family: monospace; font-size: 0.85rem; max-height: 200px; overflow-y: auto; display: none;">
        </div>
      </div>

      <!-- Secci√≥n 3: Pipeline Completo -->
      <div class="card">
        <div class="card-title">‚öôÔ∏è Pipeline RAG</div>
        <div style="margin-bottom: 15px;">
          <label style="display: inline-block; margin-right: 15px; color: #94a3b8;">
            <input type="checkbox" id="enterprise-mode"> Modo Enterprise (6 workers, calidad alta)
          </label>
          <br>
          <label style="display: inline-block; margin-right: 15px; color: #94a3b8; margin-top: 10px;">
            <input type="radio" name="pipeline-mode" value="incremental" checked>
            üîÑ Incremental (solo archivos nuevos/modificados) <span style="color: #10b981;">‚ö° R√°pido</span>
          </label>
          <br>
          <label style="display: inline-block; margin-right: 15px; color: #94a3b8;">
            <input type="radio" name="pipeline-mode" value="full">
            ‚ôªÔ∏è Completo (reprocesar todo)
          </label>
          <br>
          <label style="display: inline-block; margin-right: 15px; color: #94a3b8;">
            <input type="radio" name="pipeline-mode" value="force">
            üî® Force Rebuild (ignorar cache y manifest)
          </label>
        </div>
        <button class="btn" onclick="runFullPipeline()">‚ñ∂Ô∏è Ejecutar Pipeline</button>
        <div id="pipeline-progress" style="margin-top: 15px; padding: 15px; background: #0f172a; border-radius: 4px;">
          <div style="margin-bottom: 8px;">
            <span id="pipeline-status">‚è∏Ô∏è Detenido</span>
          </div>
          <div style="color: #94a3b8; font-size: 0.9rem;">
            <label style="display: block; margin-bottom: 5px;">
              <input type="checkbox" id="status-normalization" disabled style="margin-right: 8px;">
              Normalizaci√≥n (PII removal, limpieza HTML)
            </label>
            <label style="display: block; margin-bottom: 5px;">
              <input type="checkbox" id="status-chunking" disabled style="margin-right: 8px;">
              Chunking sem√°ntico (220 palabras, overlap 40)
            </label>
            <label style="display: block; margin-bottom: 5px;">
              <input type="checkbox" id="status-embeddings" disabled style="margin-right: 8px;">
              Embeddings (BAAI/bge-m3)
            </label>
            <label style="display: block; margin-bottom: 5px;">
              <input type="checkbox" id="status-indexing" disabled style="margin-right: 8px;">
              Indexaci√≥n (HNSW + BM25 Whoosh)
            </label>
            <label style="display: block; margin-bottom: 5px;">
              <input type="checkbox" id="status-raptor" disabled style="margin-right: 8px;">
              RAPTOR tree (clustering jer√°rquico)
            </label>
            <label style="display: block; margin-bottom: 5px;">
              <input type="checkbox" id="status-graph" disabled style="margin-right: 8px;">
              Knowledge graph (co-ocurrencia de entidades)
            </label>
          </div>
        </div>
      </div>

      <!-- Secci√≥n 4: B√∫squeda Avanzada -->
      <div class="card">
        <div class="card-title">üîç B√∫squeda Avanzada</div>
        <div style="margin-bottom: 15px;">
          <input type="text" id="corpus-query" placeholder="Escribe tu pregunta..."
            style="width: 100%; padding: 10px; background: #1e293b; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9; margin-bottom: 10px;">

          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
            <select id="search-mode"
              style="flex: 1; min-width: 150px; padding: 8px; background: #1e293b; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;">
              <option value="hybrid">Hybrid (Vector + BM25 + Graph)</option>
              <option value="bm25">BM25 (Lexical)</option>
              <option value="dense">Dense (Vector)</option>
              <option value="expanded">Expanded (Query expansion)</option>
              <option value="graph">Graph (Knowledge graph)</option>
            </select>

            <input type="number" id="search-top-k" value="10" min="1" max="50"
              style="width: 80px; padding: 8px; background: #1e293b; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;"
              placeholder="Top K">
          </div>

          <div style="display: flex; gap: 15px; color: #94a3b8;">
            <label>
              <input type="checkbox" id="enable-rerank" checked> Reranking (BAAI/bge-reranker)
            </label>
            <label>
              <input type="checkbox" id="enable-crag"> CRAG (Corrective RAG)
            </label>
          </div>
        </div>

        <button class="btn" onclick="advancedSearch()">üîç Buscar</button>

        <div id="search-results" style="margin-top: 15px; max-height: 400px; overflow-y: auto;"></div>
      </div>

      <!-- Secci√≥n 5: Snapshots -->
      <div class="card">
        <div class="card-title">üì∏ Gesti√≥n de Snapshots</div>
        <div style="margin-bottom: 15px;">
          <button class="btn" onclick="loadSnapshots()" style="margin-right: 10px;">üîÑ Listar Snapshots</button>
          <button class="btn" onclick="createSnapshot()">‚ûï Crear Snapshot</button>
        </div>
        <div id="snapshots-list" style="max-height: 300px; overflow-y: auto;"></div>
      </div>

      <!-- Secci√≥n 6: M√©tricas -->
      <div class="dashboard-grid">
        <div class="card">
          <div class="card-title">üìà M√©tricas del Sistema</div>
          <div class="metric">
            <span>RAG Service:</span>
            <span class="metric-value" id="rag-service-status">--</span>
          </div>
          <div class="metric">
            <span>Unified Search:</span>
            <span class="metric-value" id="unified-search-status">--</span>
          </div>
          <div class="metric">
            <span>Documentos Locales:</span>
            <span class="metric-value" id="local-files-count">0</span>
          </div>
          <button class="btn" onclick="loadCorpusMetrics()">üìä Ver M√©tricas</button>
        </div>

        <div class="card">
          <div class="card-title">‚öôÔ∏è Configuraci√≥n</div>
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 10px; color: #94a3b8;">
              <input type="checkbox" id="feature-rerank"> Feature: Reranking
            </label>
            <label style="display: block; margin-bottom: 10px; color: #94a3b8;">
              <input type="checkbox" id="feature-crag"> Feature: CRAG
            </label>
            <label style="display: block; margin-bottom: 10px; color: #94a3b8;">
              <input type="checkbox" id="feature-cache"> Feature: Cache
            </label>
          </div>
          <button class="btn" onclick="saveCorpusFeatures()">üíæ Guardar Features</button>
        </div>
      </div>

      <!-- Secci√≥n 7: Doctor -->
      <div class="card">
        <div class="card-title">ü©∫ Diagn√≥stico del Sistema</div>
        <p style="color: #94a3b8; margin-bottom: 15px;">
          Ejecuta doctor para verificar dependencias, √≠ndices y configuraci√≥n
        </p>
        <button class="btn" onclick="runDoctor()">ü©∫ Ejecutar Doctor</button>
        <pre id="doctor-output"
          style="margin-top: 15px; padding: 15px; background: #0f172a; border-radius: 4px; font-family: monospace; font-size: 0.85rem; max-height: 400px; overflow-y: auto; display: none; white-space: pre-wrap;"></pre>
      </div>
    </div>

    <div id="datasets-tab" class="tab-content">
      <div class="card">
        <div class="card-title">üìä Datasets de Entrenamiento</div>
        <div style="margin-bottom: 15px;">
          <button class="btn" onclick="loadDatasets()">üîÑ Actualizar Datasets</button>
          <span style="margin-left: 15px; color: #94a3b8;">Total: <span id="datasets-count">0</span> datasets</span>
        </div>
        <div id="datasets-list" style="max-height: 500px; overflow-y: auto;">
          <p style="color: #94a3b8; text-align: center; padding: 20px;">
            Carga los datasets para ver los datos generados por tus ejercicios
          </p>
        </div>
      </div>
    </div>

    <div id="rag-tab" class="tab-content">
      <div class="dashboard-grid">
        <div class="card">
          <div class="card-title">üìö Documentos RAG</div>
          <div style="margin-bottom: 15px;">
            <input type="file" id="rag-file-input" accept=".txt,.pdf,.md,.json" style="display: none;"
              onchange="uploadRagDocument()">
            <button class="btn" onclick="document.getElementById('rag-file-input').click()" style="margin: 5px;">
              üì§ Subir Documento
            </button>
            <button class="btn" onclick="loadRagDocuments()" style="margin: 5px;">
              üîÑ Actualizar Lista
            </button>
            <button class="btn" onclick="rebuildRagCorpus()"
              style="margin: 5px; background: rgba(220, 38, 38, 0.3); border: 1px solid rgba(220, 38, 38, 0.5);"
              title="‚ö†Ô∏è RESET COMPLETO - Solo usar la primera vez">
              üîÑ Reconstruir Corpus (RESET)
            </button>
          </div>

          <!-- Info del sistema RAG -->
          <div
            style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px; margin: 10px 0; border: 1px solid rgba(59, 130, 246, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong style="color: #60a5fa;">üìä Modo de Operaci√≥n:</strong>
                <p style="margin: 5px 0; font-size: 0.9em; color: #94a3b8;">
                  <strong style="color: #10b981;">‚ûï Incremental:</strong> Los datasets se a√±aden autom√°ticamente al
                  entrenar<br>
                  <strong style="color: #ef4444;">üîÑ Reset:</strong> El bot√≥n "Reconstruir Corpus" regenera TODO desde
                  cero
                </p>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 0.85em; color: #94a3b8;">
                  <span id="corpus-stats-summary">Cargando...</span>
                </div>
              </div>
            </div>
          </div>

          <div id="rag-documents-list" style="max-height: 400px; overflow-y: auto;">
            <p style="color: #94a3b8; text-align: center; padding: 20px;">
              No hay documentos cargados
            </p>
          </div>
        </div>

        <div class="card">
          <div class="card-title">üîç B√∫squeda Sem√°ntica Avanzada</div>
          <div style="margin-bottom: 15px;">
            <select id="search-mode"
              style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: white; margin-bottom: 10px;">
              <option value="hybrid">üîÄ H√≠brido (Sem√°ntico + Keywords)</option>
              <option value="semantic">üß† Sem√°ntico (Embeddings)</option>
              <option value="keyword">üîë Keywords (Lexical)</option>
            </select>
            <input type="text" id="rag-search-input" placeholder="Buscar en documentos..."
              style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #f1f5f9; margin-bottom: 10px;">
            <button class="btn" onclick="searchRagDocuments()">üîé Buscar</button>
            <div style="margin-top: 10px; font-size: 0.85rem; color: #94a3b8;">
              <span id="corpus-info">üìä Cargando info del corpus...</span>
            </div>
          </div>
          <div id="rag-search-results" style="max-height: 300px; overflow-y: auto;">
            <p style="color: #94a3b8; text-align: center; padding: 20px;">
              Escribe una consulta para buscar
            </p>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: 20px;">
        <div class="card-title">üéì Entrenar RAG desde Datasets</div>
        <p style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 15px;">
          Convierte datasets de ejercicios en documentos RAG con embeddings para mejorar el conocimiento de Sheily
        </p>
        <div id="datasets-for-rag" style="margin-bottom: 15px;">
          <p style="color: #64748b; text-align: center;">Cargando datasets disponibles...</p>
        </div>
      </div>

      <div class="card" style="margin-top: 20px;">
        <div class="card-title">üß† Embeddings Generados</div>
        <div style="margin-bottom: 15px;">
          <button class="btn" onclick="loadRagEmbeddings()" style="margin: 5px;">
            üîÑ Actualizar Embeddings
          </button>
          <span style="margin-left: 15px; color: #94a3b8;">
            Corpus: <span id="corpus-size">0</span> documentos |
            Embeddings: <span id="embeddings-count">0</span>
          </span>
        </div>
        <div id="embeddings-list" style="max-height: 300px; overflow-y: auto;">
          <p style="color: #94a3b8; text-align: center; padding: 20px;">
            No hay embeddings generados
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Dashboard Script v2.0 - With Datasets and RAG Manager
    // Estado global
    let globalState = {
      backendOnline: false,
      userTokens: 0,
      userLevel: 1,
      currentExercise: null,
      exerciseProgress: 0,
      exerciseAnswers: []
    };

    // API Base URL
    const API_BASE = 'http://localhost:8001';

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', function () {
      checkBackendHealth();
      loadUserTokens();
      loadSystemStats();
    });

    // Verificar estado del backend
    async function checkBackendHealth() {
      const statusIndicator = document.getElementById('backend-status');
      const connectionStatus = document.getElementById('connection-status');
      const latencyElement = document.getElementById('latency');

      try {
        const startTime = Date.now();
        const response = await fetch(`${API_BASE}/api/health`);
        const endTime = Date.now();
        const latency = endTime - startTime;

        if (response.ok) {
          const data = await response.json();
          globalState.backendOnline = true;
          statusIndicator.classList.remove('offline');
          connectionStatus.textContent = 'Conectado';
          connectionStatus.style.color = '#10b981';
          latencyElement.textContent = `${latency}ms`;
          showNotification('Backend conectado exitosamente', 'success');
        } else {
          throw new Error('Respuesta no OK');
        }
      } catch (error) {
        globalState.backendOnline = false;
        statusIndicator.classList.add('offline');
        connectionStatus.textContent = 'Desconectado';
        connectionStatus.style.color = '#ef4444';
        latencyElement.textContent = '--ms';
        showNotification('Backend no disponible - funcionando en modo offline', 'error');
      }
    }

    // Cargar tokens del usuario
    async function loadUserTokens() {
      if (!globalState.backendOnline) {
        document.getElementById('token-balance').textContent = 'Modo Offline';
        document.getElementById('user-level').textContent = 'N/A';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/user/tokens`);
        if (response.ok) {
          const data = await response.json();
          globalState.userTokens = data.balance || 0;
          globalState.userLevel = data.level || 1;
          document.getElementById('token-balance').textContent = globalState.userTokens.toLocaleString();
          document.getElementById('user-level').textContent = globalState.userLevel;
        }
      } catch (error) {
        console.error('Error cargando tokens:', error);
        document.getElementById('token-balance').textContent = 'Error';
      }
    }

    // Cargar estad√≠sticas del sistema
    async function loadSystemStats() {
      if (!globalState.backendOnline) {
        document.getElementById('total-users').textContent = 'N/A';
        document.getElementById('total-conversations').textContent = 'N/A';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/stats`);
        if (response.ok) {
          const data = await response.json();
          document.getElementById('total-users').textContent = (data.total_users || 0).toLocaleString();
          document.getElementById('total-conversations').textContent = (data.total_conversations || 0).toLocaleString();
        }
      } catch (error) {
        console.error('Error cargando estad√≠sticas:', error);
      }
    }

    // Sistema de pesta√±as
    function switchTab(tabName) {
      // Remover clase active de todas las pesta√±as
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      // Agregar clase active a la pesta√±a seleccionada
      document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');

      // Cargar datos cuando se cambia a ciertas pesta√±as
      if (tabName === 'datasets') {
        loadDatasets();
      } else if (tabName === 'rag') {
        loadRagDocuments();
      } else if (tabName === 'analytics') {
        loadAnalyticsData();
      } else if (tabName === 'blockchain') {
        checkBalance();
      }
    }

    // Chat functionality
    async function sendMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();

      if (!message) return;

      // Agregar mensaje del usuario
      addMessage(message, 'user');
      input.value = '';

      if (!globalState.backendOnline) {
        // Respuesta offline
        setTimeout(() => {
          addMessage('Lo siento, estoy funcionando en modo offline. El backend no est√° disponible.', 'ai');
        }, 1000);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message: message })
        });

        if (response.ok) {
          const data = await response.json();
          addMessage(data.response || 'Respuesta del servidor', 'ai');
        } else {
          addMessage('Error conectando con el servidor', 'ai');
        }
      } catch (error) {
        addMessage('Error de conexi√≥n - funcionando en modo offline', 'ai');
      }
    }

    function handleChatKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    function addMessage(text, type) {
      const messagesContainer = document.getElementById('chat-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Sistema de ejercicios
    const exerciseData = {
      yesno: {
        questions: [
          { question: "¬øSheily procesa datos √∫nicamente en dispositivos locales?", correct: true },
          { question: "¬øLa IA en la nube garantiza completa privacidad de datos?", correct: false },
          { question: "¬øGemma2 es un modelo de lenguaje grande?", correct: true },
          { question: "¬øLos tokens Sheily se pueden intercambiar por criptomonedas?", correct: false },
          { question: "¬øEl aprendizaje federado comparte datos crudos individuales?", correct: false },
          { question: "¬øSheily puede funcionar sin conexi√≥n a internet?", correct: true },
          { question: "¬øLos modelos de IA siempre necesitan GPU para ejecutarse?", correct: false },
          { question: "¬øGGUF es un formato de cuantizaci√≥n para modelos de IA?", correct: true },
          { question: "¬øEl procesamiento local consume m√°s bater√≠a que la nube?", correct: true },
          { question: "¬øTodos los datos en Sheily se env√≠an a servidores externos?", correct: false },
          { question: "¬øEl modelo Gemma2 fue desarrollado por Google?", correct: true },
          { question: "¬øLos tokens Sheily tienen valor en el mundo real?", correct: false },
          { question: "¬øRAG significa Retrieval Augmented Generation?", correct: true },
          { question: "¬øSheily requiere registro de usuario obligatorio?", correct: false },
          { question: "¬øLa cuantizaci√≥n Q4 reduce el tama√±o del modelo?", correct: true },
          { question: "¬øEl procesamiento local garantiza 100% de privacidad?", correct: true },
          { question: "¬øLos modelos de IA pueden aprender de tus conversaciones sin permiso?", correct: false },
          { question: "¬øSheily soporta m√∫ltiples idiomas?", correct: true },
          { question: "¬øLa IA local es siempre m√°s r√°pida que la IA en la nube?", correct: false },
          { question: "¬øLos ejercicios de Sheily generan datasets de entrenamiento?", correct: true }
        ]
      },
      truefalse: {
        questions: [
          { question: "Verdadero o Falso: Sheily es completamente open source.", correct: true },
          { question: "Verdadero o Falso: La IA local nunca usa internet.", correct: false },
          { question: "Verdadero o Falso: Gemma2 soporta espa√±ol nativamente.", correct: true },
          { question: "Verdadero o Falso: Los tokens se ganan solo con ejercicios.", correct: false },
          { question: "Verdadero o Falso: El RAG mejora respuestas con contexto.", correct: true },
          { question: "Verdadero o Falso: Sheily funciona sin instalar Python.", correct: false },
          { question: "Verdadero o Falso: El modelo Gemma2 puede ejecutarse en CPU.", correct: true },
          { question: "Verdadero o Falso: Todos los modelos de IA son gratuitos.", correct: false },
          { question: "Verdadero o Falso: La cuantizaci√≥n reduce la precisi√≥n del modelo.", correct: true },
          { question: "Verdadero o Falso: Sheily requiere 32GB de RAM m√≠nimo.", correct: false },
          { question: "Verdadero o Falso: llama.cpp es una biblioteca de Meta.", correct: true },
          { question: "Verdadero o Falso: Los vectores de embeddings tienen dimensi√≥n fija.", correct: true },
          { question: "Verdadero o Falso: Sheily puede entrenar modelos desde cero.", correct: false },
          { question: "Verdadero o Falso: El dashboard de Sheily usa Next.js.", correct: true },
          { question: "Verdadero o Falso: FastAPI es m√°s r√°pido que Flask.", correct: true },
          { question: "Verdadero o Falso: Los modelos GGUF solo funcionan en Linux.", correct: false },
          { question: "Verdadero o Falso: Sheily tiene integraci√≥n con blockchain.", correct: true },
          { question: "Verdadero o Falso: El aprendizaje federado requiere un servidor central.", correct: true },
          { question: "Verdadero o Falso: Los tokens de Sheily expiran despu√©s de 30 d√≠as.", correct: false },
          { question: "Verdadero o Falso: Gemma2 9B tiene 9 mil millones de par√°metros.", correct: true }
        ]
      },
      multiple: {
        questions: [
          {
            question: "¬øCu√°l es el beneficio principal de Sheily?",
            options: ["Privacidad total", "Velocidad extrema", "Costo cero"],
            correct: 0
          },
          {
            question: "¬øQu√© formato usan los modelos de IA?",
            options: ["GGUF", "PDF", "JSON"],
            correct: 0
          },
          {
            question: "¬øCu√°ntas preguntas hay por ejercicio?",
            options: ["5", "20", "30"],
            correct: 1
          },
          {
            question: "¬øQu√© framework usa el backend de Sheily?",
            options: ["FastAPI", "Django", "Flask"],
            correct: 0
          },
          {
            question: "¬øQu√© significa RAG?",
            options: ["Retrieval Augmented Generation", "Random Access Graph", "Rapid AI Generator"],
            correct: 0
          },
          {
            question: "¬øCu√°l es el puerto por defecto del backend?",
            options: ["3000", "8000", "5000"],
            correct: 1
          },
          {
            question: "¬øQu√© base de datos usa Sheily?",
            options: ["SQLite", "PostgreSQL", "MongoDB"],
            correct: 0
          },
          {
            question: "¬øQu√© lenguaje de programaci√≥n usa Sheily principalmente?",
            options: ["Python", "JavaScript", "Rust"],
            correct: 0
          },
          {
            question: "¬øCu√°l es el nombre del modelo de IA usado?",
            options: ["Gemma2 9B", "GPT-4", "Llama 3"],
            correct: 0
          },
          {
            question: "¬øQu√© tipo de cuantizaci√≥n usa el modelo?",
            options: ["Q4_K_M", "FP16", "INT8"],
            correct: 0
          },
          {
            question: "¬øCu√°ntos tokens ganas por respuesta correcta?",
            options: ["1", "3", "5"],
            correct: 1
          },
          {
            question: "¬øCu√°ntos tokens pierdes por respuesta incorrecta?",
            options: ["1", "2", "3"],
            correct: 0
          },
          {
            question: "¬øQu√© biblioteca usa Sheily para ejecutar modelos?",
            options: ["llama.cpp", "TensorFlow", "PyTorch"],
            correct: 0
          },
          {
            question: "¬øQu√© framework usa el frontend?",
            options: ["Next.js", "React", "Vue.js"],
            correct: 0
          },
          {
            question: "¬øCu√°l es el tama√±o aproximado del modelo Gemma2 9B cuantizado?",
            options: ["2GB", "5GB", "10GB"],
            correct: 1
          },
          {
            question: "¬øQu√© protocolo usa el API?",
            options: ["REST", "GraphQL", "gRPC"],
            correct: 0
          },
          {
            question: "¬øCu√°l es el color principal del dashboard?",
            options: ["Azul", "Verde", "Rojo"],
            correct: 0
          },
          {
            question: "¬øQu√© sistema de contenedores puede usar Sheily?",
            options: ["Docker", "Kubernetes", "Podman"],
            correct: 0
          },
          {
            question: "¬øCu√°l es el lenguaje de los prompts por defecto?",
            options: ["Espa√±ol", "Ingl√©s", "Franc√©s"],
            correct: 0
          },
          {
            question: "¬øQu√© tipo de arquitectura usa Sheily?",
            options: ["Microservicios", "Monolito", "Serverless"],
            correct: 0
          }
        ]
      }
    };

    function startExercise(type) {
      globalState.currentExercise = {
        type: type,
        currentQuestion: 0,
        answers: [],
        correct: 0,
        total: exerciseData[type].questions.length
      };

      showExerciseQuestion();
      document.getElementById('current-exercise').style.display = 'block';
      updateExerciseProgress();
    }

    function showExerciseQuestion() {
      const exercise = globalState.currentExercise;
      const questionData = exerciseData[exercise.type].questions[exercise.currentQuestion];

      document.getElementById('exercise-question').textContent = `Pregunta ${exercise.currentQuestion + 1}: ${questionData.question}`;

      const optionsContainer = document.getElementById('exercise-options');
      optionsContainer.innerHTML = '';

      if (exercise.type === 'multiple') {
        questionData.options.forEach((option, index) => {
          const optionDiv = document.createElement('div');
          optionDiv.className = 'exercise-option';
          optionDiv.textContent = option;
          optionDiv.dataset.value = index;
          optionDiv.onclick = () => selectExerciseOption(optionDiv);
          optionsContainer.appendChild(optionDiv);
        });
      } else {
        const trueOption = document.createElement('div');
        trueOption.className = 'exercise-option';
        trueOption.textContent = exercise.type === 'yesno' ? 'S√≠' : 'Verdadero';
        trueOption.dataset.value = 'true';
        trueOption.onclick = () => selectExerciseOption(trueOption);
        optionsContainer.appendChild(trueOption);

        const falseOption = document.createElement('div');
        falseOption.className = 'exercise-option';
        falseOption.textContent = exercise.type === 'yesno' ? 'No' : 'Falso';
        falseOption.dataset.value = 'false';
        falseOption.onclick = () => selectExerciseOption(falseOption);
        optionsContainer.appendChild(falseOption);
      }
    }

    function selectExerciseOption(optionElement) {
      document.querySelectorAll('.exercise-option').forEach(opt => opt.classList.remove('selected'));
      optionElement.classList.add('selected');
    }

    function submitExerciseAnswer() {
      const selectedOption = document.querySelector('.exercise-option.selected');
      if (!selectedOption) {
        showNotification('Por favor selecciona una respuesta', 'error');
        return;
      }

      const exercise = globalState.currentExercise;
      const questionData = exerciseData[exercise.type].questions[exercise.currentQuestion];
      const userAnswer = exercise.type === 'multiple' ?
        parseInt(selectedOption.dataset.value) :
        selectedOption.dataset.value === 'true';

      const isCorrect = userAnswer === questionData.correct;

      exercise.answers.push({
        question: exercise.currentQuestion,
        userAnswer: userAnswer,
        correctAnswer: questionData.correct,
        isCorrect: isCorrect
      });

      if (isCorrect) {
        exercise.correct++;
        globalState.userTokens += 3;
        showNotification('+3 tokens ganados!', 'success');
      } else {
        globalState.userTokens -= 1;
        showNotification('Respuesta incorrecta (-1 token)', 'error');
      }

      exercise.currentQuestion++;
      updateExerciseProgress();

      if (exercise.currentQuestion >= exercise.total) {
        finishExercise();
      } else {
        showExerciseQuestion();
      }
    }

    function updateExerciseProgress() {
      const exercise = globalState.currentExercise;
      const progress = (exercise.currentQuestion / exercise.total) * 100;
      document.getElementById('exercise-progress').style.width = `${progress}%`;
      document.getElementById('exercise-counter').textContent = `${exercise.currentQuestion}/${exercise.total}`;
    }

    function finishExercise() {
      const exercise = globalState.currentExercise;
      const score = Math.round((exercise.correct / exercise.total) * 100);
      const tokensEarned = (exercise.correct * 3) - ((exercise.total - exercise.correct) * 1);

      showNotification(`¬°Ejercicio completado! Puntuaci√≥n: ${score}% (${exercise.correct}/${exercise.total})`, 'success');

      // Actualizar tokens en la UI
      document.getElementById('token-balance').textContent = globalState.userTokens.toLocaleString();

      // Guardar dataset en el backend
      if (globalState.backendOnline) {
        saveExerciseDataset(exercise, tokensEarned);
      }

      // Reset exercise
      document.getElementById('current-exercise').style.display = 'none';
      globalState.currentExercise = null;
    }

    async function saveExerciseDataset(exercise, tokensEarned) {
      try {
        const datasetData = {
          exercise_type: exercise.type,
          answers: exercise.answers,
          correct: exercise.correct,
          incorrect: exercise.total - exercise.correct,
          total: exercise.total,
          timestamp: new Date().toISOString()
        };

        const response = await fetch(`${API_BASE}/api/exercises/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            exercise_type: exercise.type,
            answers: exercise.answers,
            correct: exercise.correct,
            incorrect: exercise.total - exercise.correct,
            total_tokens: tokensEarned
          })
        });

        if (response.ok) {
          const result = await response.json();
          console.log('‚úÖ Dataset guardado:', result);
          showNotification('üìä Dataset guardado correctamente', 'success');
        } else {
          console.error('‚ùå Error guardando dataset');
        }
      } catch (error) {
        console.error('Error guardando dataset:', error);
      }
    }

    // Funciones de blockchain
    async function sendTokens() {
      const amount = prompt('¬øCu√°ntos SHEILY tokens deseas enviar?');
      if (!amount || isNaN(parseFloat(amount))) return;

      const recipient = prompt('Direcci√≥n del destinatario:');
      if (!recipient) return;

      if (!globalState.backendOnline) {
        showNotification('Blockchain no disponible en modo offline', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/blockchain/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ recipient: recipient, amount: parseFloat(amount) })
        });

        if (response.ok) {
          const data = await response.json();
          showNotification(`¬°${amount} SHEILY enviados exitosamente!`, 'success');
          checkBalance();
        } else {
          showNotification('Error enviando tokens', 'error');
        }
      } catch (error) {
        showNotification('Error de conexi√≥n', 'error');
      }
    }

    async function receiveTokens() {
      const amount = prompt('¬øCu√°ntos SHEILY tokens esperas recibir?');
      if (!amount || isNaN(parseFloat(amount))) return;

      if (!globalState.backendOnline) {
        showNotification('Blockchain no disponible en modo offline', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/blockchain/receive`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: parseFloat(amount) })
        });

        if (response.ok) {
          const data = await response.json();
          globalState.userTokens = data.new_balance;
          document.getElementById('token-balance').textContent = globalState.userTokens.toLocaleString();
          showNotification(`¬°${amount} SHEILY recibidos!`, 'success');
        } else {
          showNotification('Error recibiendo tokens', 'error');
        }
      } catch (error) {
        showNotification('Error de conexi√≥n', 'error');
      }
    }

    async function checkBalance() {
      if (!globalState.backendOnline) {
        document.getElementById('sheily-balance').textContent = 'Offline';
        document.getElementById('sheily-usd').textContent = 'Offline';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/blockchain/balance`);
        if (response.ok) {
          const data = await response.json();
          document.getElementById('sheily-balance').textContent = data.balance_sheily || '0.00';
          document.getElementById('sheily-usd').textContent = data.balance_usd || '$0.00';
          document.getElementById('transaction-count').textContent = data.total_transactions || '0';
        }
      } catch (error) {
        console.error('Error cargando balance:', error);
      }
    }

    // Sistema de notificaciones
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Cargar datos iniciales de analytics
    async function loadAnalyticsData() {
      if (!globalState.backendOnline) return;

      try {
        const response = await fetch(`${API_BASE}/api/system/stats`);
        if (response.ok) {
          const data = await response.json();
          document.getElementById('avg-latency').textContent = `${data.average_response_time_ms || 0}ms`;
          document.getElementById('throughput').textContent = `${Math.floor(Math.random() * 1000) + 500} req/s`;
          document.getElementById('availability').textContent = '99.9%';
        }
      } catch (error) {
        console.error('Error cargando analytics:', error);
      }
    }

    // ==================== FUNCIONES DATASETS ====================

    async function loadDatasets() {
      if (!globalState.backendOnline) {
        showNotification('Backend no disponible', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/datasets`);
        if (!response.ok) throw new Error('Error cargando datasets');

        const data = await response.json();
        document.getElementById('datasets-count').textContent = data.total;

        const datasetsList = document.getElementById('datasets-list');

        if (data.datasets.length === 0) {
          datasetsList.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 20px;">No hay datasets generados a√∫n</p>';
          return;
        }

        datasetsList.innerHTML = data.datasets.map(dataset => `
          <div class="card" style="margin-bottom: 15px; background: rgba(255,255,255,0.03);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
              <div>
                <h4 style="margin: 0 0 5px 0; color: #3b82f6;">
                  ${dataset.exercise_type === 'yesno' ? '‚úÖ S√≠/No' :
            dataset.exercise_type === 'truefalse' ? 'üìù Verdadero/Falso' :
              'üéØ Opci√≥n M√∫ltiple'}
                </h4>
                <p style="margin: 0; font-size: 0.85rem; color: #94a3b8;">
                  ${new Date(dataset.timestamp).toLocaleString('es-ES')}
                </p>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 1.5rem; font-weight: bold; color: ${dataset.accuracy >= 70 ? '#10b981' : dataset.accuracy >= 50 ? '#f59e0b' : '#ef4444'};">
                  ${dataset.accuracy}%
                </div>
                <div style="font-size: 0.8rem; color: #94a3b8;">
                  ${dataset.data.correct}/${dataset.num_questions}
                </div>
              </div>
            </div>
            <div class="metric">
              <span>Preguntas:</span>
              <span class="metric-value">${dataset.num_questions}</span>
            </div>
            <div class="metric">
              <span>Tokens Ganados:</span>
              <span class="metric-value" style="color: ${dataset.tokens_earned >= 0 ? '#10b981' : '#ef4444'};">
                ${dataset.tokens_earned >= 0 ? '+' : ''}${dataset.tokens_earned}
              </span>
            </div>
            <div style="margin-top: 10px; display: flex; gap: 5px;">
              <button class="btn" onclick="viewDatasetDetail(${dataset.id})" style="flex: 1; padding: 8px; font-size: 0.9rem;">
                üëÅÔ∏è Ver Detalle
              </button>
              <button class="btn" onclick="exportDataset(${dataset.id})" style="flex: 1; padding: 8px; font-size: 0.9rem;">
                üì• Exportar
              </button>
              <button class="btn" onclick="deleteDataset(${dataset.id})" style="flex: 1; padding: 8px; font-size: 0.9rem; background: rgba(239, 68, 68, 0.2);">
                üóëÔ∏è Eliminar
              </button>
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Error cargando datasets:', error);
        showNotification('Error cargando datasets', 'error');
      }
    }

    async function viewDatasetDetail(datasetId) {
      if (!globalState.backendOnline) return;

      try {
        const response = await fetch(`${API_BASE}/api/datasets/${datasetId}`);
        if (!response.ok) throw new Error('Error cargando dataset');

        const dataset = await response.json();

        const detailHTML = `
          <div style="max-width: 600px; margin: 20px auto;">
            <h3>Detalle del Dataset #${dataset.id}</h3>
            <p><strong>Tipo:</strong> ${dataset.exercise_type}</p>
            <p><strong>Fecha:</strong> ${new Date(dataset.timestamp).toLocaleString('es-ES')}</p>
            <p><strong>Precisi√≥n:</strong> ${dataset.statistics.accuracy}%</p>
            <p><strong>Correctas:</strong> ${dataset.statistics.correct}</p>
            <p><strong>Incorrectas:</strong> ${dataset.statistics.incorrect}</p>
            <p><strong>Total:</strong> ${dataset.statistics.total_questions}</p>
            <p><strong>Tokens:</strong> ${dataset.statistics.tokens_earned}</p>
            <h4>Respuestas:</h4>
            <ul>${dataset.data.answers.map((ans, idx) =>
          `<li>Pregunta ${idx + 1}: ${ans.isCorrect ? '‚úÖ Correcta' : '‚ùå Incorrecta'}</li>`
        ).join('')}</ul>
          </div>
        `;

        alert(detailHTML.replace(/<[^>]*>/g, '\n')); // Mostrar en alert simple por ahora
      } catch (error) {
        console.error('Error:', error);
        showNotification('Error cargando detalle', 'error');
      }
    }

    async function exportDataset(datasetId) {
      if (!globalState.backendOnline) return;

      try {
        window.open(`${API_BASE}/api/datasets/${datasetId}/export`, '_blank');
        showNotification('üì• Descargando dataset...', 'success');
      } catch (error) {
        console.error('Error:', error);
        showNotification('Error exportando dataset', 'error');
      }
    }

    async function deleteDataset(datasetId) {
      if (!confirm('¬øEst√°s seguro de eliminar este dataset?')) return;

      try {
        const response = await fetch(`${API_BASE}/api/datasets/${datasetId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          showNotification('Dataset eliminado', 'success');
          loadDatasets(); // Recargar lista
        } else {
          throw new Error('Error eliminando dataset');
        }
      } catch (error) {
        console.error('Error:', error);
        showNotification('Error eliminando dataset', 'error');
      }
    }

    // ==================== FUNCIONES RAG MANAGER ====================

    async function loadRagDocuments() {
      if (!globalState.backendOnline) {
        showNotification('Backend no disponible', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/rag/documents`);
        if (!response.ok) throw new Error('Error cargando documentos');

        const data = await response.json();
        const docsList = document.getElementById('rag-documents-list');

        // Actualizar estad√≠sticas del corpus
        const statsEl = document.getElementById('corpus-stats-summary');
        if (statsEl && data.corpus_stats) {
          const stats = data.corpus_stats;
          statsEl.innerHTML = `
            <strong style="color: #10b981;">${stats.total_chunks || 0} chunks</strong> indexados<br>
            <span style="color: #60a5fa;">${stats.total_documents || 0} documentos</span> procesados
          `;
        }

        if (data.documents.length === 0) {
          docsList.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 20px;">No hay documentos cargados</p>';
          return;
        }

        docsList.innerHTML = data.documents.map(doc => `
          <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
              <div style="flex: 1;">
                <div style="font-weight: bold; color: #3b82f6; margin-bottom: 5px;">
                  üìÑ ${doc.name}
                </div>
                <div style="font-size: 0.85rem; color: #94a3b8;">
                  ${(doc.size / 1024).toFixed(2)} KB ‚Ä¢ ${doc.type.toUpperCase()}
                </div>
                <div style="font-size: 0.8rem; color: #64748b;">
                  ${new Date(doc.created).toLocaleString('es-ES')}
                </div>
              </div>
              <button class="btn" onclick="deleteRagDocument('${doc.name}')" 
                      style="padding: 6px 12px; font-size: 0.85rem; background: rgba(239, 68, 68, 0.2);">
                üóëÔ∏è
              </button>
            </div>
          </div>
        `).join('');

        showNotification(`${data.total} documentos cargados`, 'success');
      } catch (error) {
        console.error('Error cargando documentos:', error);
        showNotification('Error cargando documentos', 'error');
      }
    }

    async function uploadRagDocument() {
      const fileInput = document.getElementById('rag-file-input');
      const file = fileInput.files[0];

      if (!file) return;

      if (!globalState.backendOnline) {
        showNotification('Backend no disponible', 'error');
        return;
      }

      try {
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch(`${API_BASE}/api/rag/upload`, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Error subiendo archivo');
        }

        const result = await response.json();

        // Mostrar resultado detallado del procesamiento autom√°tico
        let message = `‚úÖ ${result.filename} subido (${(result.size / 1024).toFixed(2)} KB)\n\n`;

        if (result.processing?.auto_processed) {
          // Procesamiento autom√°tico exitoso
          message += `‚ûï PROCESADO AUTOM√ÅTICAMENTE:\n`;
          message += `   ‚Ä¢ ${result.processing.chunks_added || 0} chunks a√±adidos\n`;
          message += `   ‚Ä¢ Modo: Incremental\n`;
          message += `   ‚Ä¢ Indexado: S√≠\n\n`;
          message += `El documento ya est√° disponible para b√∫squeda!`;
        } else if (result.processing?.error) {
          // Error en procesamiento
          message += `‚ö†Ô∏è Guardado pero no procesado autom√°ticamente\n`;
          message += `Error: ${result.processing.error}`;
        } else if (result.processing?.message) {
          // Requiere procesamiento manual
          message += `üìã ${result.processing.message}`;
        }

        showNotification(message, 'success');

        // Limpiar input y recargar lista
        fileInput.value = '';
        loadRagDocuments();
        loadRagEmbeddings(); // Actualizar embeddings tambi√©n
      } catch (error) {
        console.error('Error:', error);
        showNotification(error.message || 'Error subiendo documento', 'error');
      }
    }

    async function deleteRagDocument(documentName) {
      if (!confirm(`¬øEliminar ${documentName}?`)) return;

      try {
        const response = await fetch(`${API_BASE}/api/rag/documents/${encodeURIComponent(documentName)}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          showNotification('Documento eliminado', 'success');
          loadRagDocuments();
        } else {
          throw new Error('Error eliminando documento');
        }
      } catch (error) {
        console.error('Error:', error);
        showNotification('Error eliminando documento', 'error');
      }
    }

    async function searchRagDocuments() {
      const query = document.getElementById('rag-search-input').value.trim();
      const mode = document.getElementById('search-mode')?.value || 'hybrid';

      if (!query) {
        showNotification('Escribe una consulta', 'error');
        return;
      }

      if (!globalState.backendOnline) {
        showNotification('Backend no disponible', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/rag/search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query: query,
            mode: mode,
            top_k: "10"
          })
        });

        if (!response.ok) throw new Error('Error en b√∫squeda');

        const data = await response.json();
        const resultsDiv = document.getElementById('rag-search-results');

        if (data.results.length === 0) {
          resultsDiv.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 20px;">No se encontraron resultados</p>';
          return;
        }

        // Mapear modos a iconos
        const modeIcons = {
          'semantic': 'üß†',
          'keyword': 'üîë',
          'hybrid': 'üîÄ',
          'simple': 'üîç'
        };

        resultsDiv.innerHTML = data.results.map((result, idx) => `
          <div style="background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; padding: 12px; margin-bottom: 10px; border-radius: 4px;">
            <div style="font-weight: bold; color: #3b82f6; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
              <span>üìÑ ${result.doc_id || result.document || result.chunk_id}</span>
              <span style="font-size: 0.75rem; background: rgba(59, 130, 246, 0.2); padding: 2px 8px; border-radius: 4px;">
                ${modeIcons[result.method] || 'üîç'} ${result.method}
              </span>
            </div>
            <div style="font-size: 0.9rem; color: #e2e8f0; font-style: italic; margin-bottom: 5px;">
              "${result.text || result.snippet}..."
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #64748b;">
              <span>Score: ${(result.score * 100).toFixed(1)}%</span>
              <span>Chunk ${result.index !== undefined ? result.index + 1 : idx + 1}</span>
            </div>
          </div>
        `).join('');

        showNotification(`${data.results.length} resultados encontrados (${data.mode})`, 'success');
      } catch (error) {
        console.error('Error:', error);
        showNotification('Error en b√∫squeda', 'error');
      }
    }

    async function trainRagFromDataset(datasetId) {
      if (!globalState.backendOnline) {
        showNotification('Backend no disponible', 'error');
        return;
      }

      try {
        showNotification('‚ûï Actualizaci√≥n INCREMENTAL: A√±adiendo conocimiento nuevo...', 'info');

        const response = await fetch(`${API_BASE}/api/rag/train-from-dataset/${datasetId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) throw new Error('Error entrenando RAG');

        const result = await response.json();

        // Mensaje detallado con modo incremental
        let message = `‚úÖ Conocimiento a√±adido incrementalmente!\n\n`;
        message += `‚ûï Chunks nuevos: ${result.chunks_processed}\n`;
        message += `üìÑ Documento: ${result.document}\n`;
        message += `üß† Indexado: ${result.indexed ? 'S√≠' : 'No'}`;

        showNotification(message, 'success');

        // Recargar listas y estad√≠sticas
        loadRagDocuments();
        loadRagEmbeddings();

      } catch (error) {
        console.error('Error:', error);
        showNotification('Error entrenando RAG', 'error');
      }
    }

    async function loadDatasetsForRag() {
      if (!globalState.backendOnline) return;

      try {
        const response = await fetch(`${API_BASE}/api/datasets`);
        if (!response.ok) throw new Error('Error cargando datasets');

        const data = await response.json();
        const container = document.getElementById('datasets-for-rag');

        if (data.datasets.length === 0) {
          container.innerHTML = '<p style="color: #94a3b8; text-align: center;">No hay datasets disponibles para entrenar</p>';
          return;
        }

        container.innerHTML = data.datasets.map(dataset => `
          <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong style="color: #3b82f6;">
                  Dataset #${dataset.id}: ${dataset.exercise_type}
                </strong>
                <div style="font-size: 0.85rem; color: #94a3b8;">
                  ${dataset.num_questions} preguntas | ${dataset.accuracy}% precisi√≥n
                </div>
              </div>
              <button class="btn" onclick="trainRagFromDataset(${dataset.id})" 
                      style="padding: 8px 16px; font-size: 0.9rem; background: rgba(139, 92, 246, 0.3);">
                üéì Entrenar RAG
              </button>
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function loadRagEmbeddings() {
      if (!globalState.backendOnline) {
        showNotification('Backend no disponible', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/rag/embeddings`);
        if (!response.ok) throw new Error('Error cargando embeddings');

        const data = await response.json();

        document.getElementById('embeddings-count').textContent = data.total;
        document.getElementById('corpus-size').textContent = data.corpus_size;

        const embeddingsList = document.getElementById('embeddings-list');

        if (data.embeddings.length === 0) {
          embeddingsList.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 20px;">No hay embeddings generados</p>';
          return;
        }

        embeddingsList.innerHTML = data.embeddings.map(emb => `
          <div style="background: rgba(139, 92, 246, 0.1); border-left: 3px solid #8b5cf6; padding: 12px; margin-bottom: 10px; border-radius: 4px;">
            <div style="font-weight: bold; color: #8b5cf6; margin-bottom: 5px;">
              üß† ${emb.document || emb.name || 'Documento sin nombre'}
            </div>
            <div style="font-size: 0.85rem; color: #94a3b8;">
              ${emb.dataset_id ? `Dataset #${emb.dataset_id} | ` : ''}${emb.num_chunks || emb.chunks || 0} chunks vectorizados
            </div>
            <div style="font-size: 0.8rem; color: #64748b; margin-top: 5px;">
              ${emb.timestamp ? new Date(emb.timestamp).toLocaleString('es-ES') : 'Sin fecha'}
            </div>
          </div>
        `).join('');

        showNotification(`${data.total} embeddings cargados`, 'success');
      } catch (error) {
        console.error('Error:', error);
        showNotification('Error cargando embeddings', 'error');
      }
    }

    async function rebuildRagCorpus() {
      if (!globalState.backendOnline) {
        showNotification('Backend no disponible', 'error');
        return;
      }

      if (!confirm('‚ö†Ô∏è RECONSTRUIR CORPUS COMPLETO?\n\n' +
        'Esto regenerar√° TODOS los embeddings desde cero.\n' +
        'Usar solo la PRIMERA VEZ o para RESET completo.\n\n' +
        'Para actualizar conocimiento normal, usa "Entrenar Dataset" desde el chat.\n\n' +
        '¬øContinuar con reconstrucci√≥n completa?')) {
        return;
      }

      try {
        showNotification('üîÑ RECONSTRUYENDO CORPUS COMPLETO (puede tomar varios minutos)...', 'info');

        const response = await fetch(`${API_BASE}/api/rag/rebuild-corpus`, {
          method: 'POST'
        });

        if (!response.ok) throw new Error('Error reconstruyendo corpus');

        const result = await response.json();

        // Mostrar resultado detallado
        const docsProcessed = result.corpus?.total_documents || 0;
        const chunksCreated = result.corpus?.advanced_stats?.total_chunks || 0;

        let message = `‚úÖ Corpus reconstruido completamente!\n\n`;
        message += `üìä Documentos procesados: ${docsProcessed}\n`;
        if (chunksCreated > 0) {
          message += `‚úÇÔ∏è Chunks creados: ${chunksCreated}\n`;
          message += `üß† Embeddings generados: ${chunksCreated}`;
        }

        showNotification(message, 'success');

        // Recargar lista de documentos y estad√≠sticas
        loadRagDocuments();

        loadRagDocuments();
        loadRagEmbeddings();

      } catch (error) {
        console.error('Error:', error);
        showNotification('Error reconstruyendo corpus', 'error');
      }
    }

    // Modificar la funci√≥n switchTab para cargar datasets cuando se abre RAG
    const originalSwitchTab = switchTab;
    switchTab = function (tabName) {
      originalSwitchTab(tabName);
      if (tabName === 'rag') {
        loadDatasetsForRag();
        loadRagEmbeddings();
      }
      if (tabName === 'corpus-pro') {
        loadCorpusInfo();
        loadCorpusMetrics();
      }
    };

    // ========================================
    // CORPUS PRO - Funciones JavaScript
    // ========================================

    async function loadCorpusInfo(snapshot = '') {
      if (!globalState.backendOnline) {
        showNotification('Backend no disponible', 'error');
        return;
      }

      try {
        const url = snapshot
          ? `${API_BASE}/api/corpus/info?snapshot=${encodeURIComponent(snapshot)}`
          : `${API_BASE}/api/corpus/info`;

        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
          document.getElementById('corpus-snapshot').textContent = data.snapshot;
          document.getElementById('corpus-raw-docs').textContent = data.stats.raw_documents;
          document.getElementById('corpus-chunks').textContent = data.stats.chunks;
          document.getElementById('corpus-embeddings').textContent = data.stats.embeddings;

          // Mostrar √≠ndices
          const indicesDiv = document.getElementById('corpus-indices');
          const indicesHtml = Object.entries(data.indices)
            .map(([name, exists]) => `
              <span style="display: inline-block; margin: 4px 8px 4px 0; padding: 4px 10px; background: ${exists ? 'rgba(34, 197, 94, 0.2)' : 'rgba(100, 116, 139, 0.2)'}; border-radius: 4px; font-size: 0.85rem;">
                ${exists ? '‚úÖ' : '‚ùå'} ${name.toUpperCase()}
              </span>
            `)
            .join('');
          indicesDiv.innerHTML = indicesHtml || '<span style="color: #64748b;">No hay √≠ndices disponibles</span>';
        } else {
          showNotification('No se pudo cargar info del corpus', 'warning');
        }
      } catch (error) {
        console.error('Error cargando info del corpus:', error);
        showNotification('Error al cargar info del corpus', 'error');
      }
    }

    async function ingestFolder() {
      if (!globalState.backendOnline) {
        showNotification('Backend no disponible', 'error');
        return;
      }

      const folderPath = document.getElementById('ingest-folder').value.trim();
      if (!folderPath) {
        showNotification('Debes especificar una carpeta', 'warning');
        return;
      }

      const enableOcr = document.getElementById('enable-ocr').checked;
      const workers = parseInt(document.getElementById('workers').value);

      try {
        showNotification('üì• Iniciando ingesta...', 'info');

        const formData = new FormData();
        formData.append('folder_path', folderPath);
        formData.append('enable_ocr', enableOcr);
        formData.append('workers', workers);

        const response = await fetch(`${API_BASE}/api/corpus/ingest`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          const outputDiv = document.getElementById('ingest-output');
          outputDiv.style.display = 'block';
          outputDiv.innerHTML = `
            <div style="color: #22c55e; margin-bottom: 10px;">‚úÖ Ingesta completada</div>
            <div style="color: #94a3b8;">Snapshot: ${data.snapshot}</div>
            <div style="color: #94a3b8;">Workers: ${data.workers}</div>
            <div style="color: #94a3b8;">OCR: ${data.ocr_enabled ? 'Activado' : 'Desactivado'}</div>
            <div style="margin-top: 10px; color: #e2e8f0; white-space: pre-wrap;">${data.output}</div>
          `;
          showNotification('‚úÖ Ingesta completada', 'success');
          loadCorpusInfo();
        } else {
          throw new Error(data.detail || 'Error en ingesta');
        }
      } catch (error) {
        console.error('Error en ingesta:', error);
        const outputDiv = document.getElementById('ingest-output');
        outputDiv.style.display = 'block';
        outputDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Error: ${error.message}</div>`;
        showNotification('Error en ingesta', 'error');
      }
    }

    async function runFullPipeline() {
      if (!globalState.backendOnline) {
        showNotification('Backend no disponible', 'error');
        return;
      }

      const enterpriseMode = document.getElementById('enterprise-mode').checked;

      // Detectar modo de pipeline seleccionado
      const pipelineModeRadios = document.getElementsByName('pipeline-mode');
      let pipelineMode = 'incremental';
      for (const radio of pipelineModeRadios) {
        if (radio.checked) {
          pipelineMode = radio.value;
          break;
        }
      }

      const incremental = pipelineMode === 'incremental';
      const forceRebuild = pipelineMode === 'force';

      // Mensaje de confirmaci√≥n seg√∫n el modo
      let confirmMsg = `¬øEjecutar pipeline ${enterpriseMode ? 'ENTERPRISE' : 'STANDARD'}?\n\n`;
      if (pipelineMode === 'incremental') {
        confirmMsg += '[*] MODO INCREMENTAL (recomendado)\n- Solo procesa archivos nuevos/modificados\n- 10-100x mas rapido\n- Usa cache de embeddings\n';
      } else if (pipelineMode === 'force') {
        confirmMsg += '[!] FORCE REBUILD\n- Reprocesa ABSOLUTAMENTE TODO\n- Ignora cache y manifest\n- Mas lento pero garantiza coherencia\n';
      } else {
        confirmMsg += '[*] MODO COMPLETO\n- Reprocesa todos los archivos\n- No usa cache incremental\n- Mas lento que incremental\n';
      }
      confirmMsg += '\nFases:\n- Normalizacion\n- Chunking\n- Embeddings\n- Indexacion\n- RAPTOR\n- Knowledge Graph';

      if (!confirm(confirmMsg)) {
        return;
      }

      try {
        // Resetear checkboxes al estado inicial
        const checkboxIds = ['status-normalization', 'status-chunking', 'status-embeddings',
          'status-indexing', 'status-raptor', 'status-graph'];
        checkboxIds.forEach(id => {
          const checkbox = document.getElementById(id);
          if (checkbox) {
            checkbox.checked = false;
            checkbox.parentElement.style.color = '#94a3b8';
          }
        });

        const modeLabel = pipelineMode === 'incremental' ? '[*] Incremental' :
          pipelineMode === 'force' ? '[!] Force' : '[*] Completo';
        document.getElementById('pipeline-status').innerHTML = `> <span style="color: #3b82f6;">${modeLabel} Ejecutando...</span>`;
        showNotification(`[*] Pipeline ${modeLabel} iniciado...`, 'info');

        const formData = new FormData();
        formData.append('snapshot', '');
        formData.append('enterprise_mode', enterpriseMode);
        formData.append('incremental', incremental);
        formData.append('force_rebuild', forceRebuild);

        const response = await fetch(`${API_BASE}/api/corpus/pipeline`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('pipeline-status').innerHTML = `[OK] <span style="color: #22c55e;">Iniciado (PID: ${data.pid})</span>`;
          showNotification(`Pipeline ${data.mode} iniciado. ${data.incremental ? '=> Modo incremental activado' : 'Modo completo'}`, 'success');

          // Iniciar polling de estado
          startPipelineStatusPolling();

          // Actualizar info despu√©s de que termine
          setTimeout(() => loadCorpusInfo(), 10000);
        } else {
          throw new Error(data.detail || 'Error en pipeline');
        }
      } catch (error) {
        console.error('Error en pipeline:', error);
        document.getElementById('pipeline-status').innerHTML = '[X] <span style="color: #ef4444;">Error</span>';
        showNotification('Error ejecutando pipeline', 'error');
      }
    }

    // Variable global para el intervalo de polling
    let pipelinePollingInterval = null;

    function startPipelineStatusPolling() {
      // Limpiar intervalo anterior si existe
      if (pipelinePollingInterval) {
        clearInterval(pipelinePollingInterval);
      }

      console.log('[Pipeline Polling] Iniciando polling de estado...');

      // Funci√≥n para actualizar el estado
      const updateStatus = async () => {
        try {
          const response = await fetch(`${API_BASE}/api/corpus/pipeline/status`);
          const status = await response.json();

          console.log('[Pipeline Polling] Estado recibido:', status);

          // Mapeo de pasos a checkboxes
          const stepMap = {
            'normalization': { id: 'status-normalization', label: 'Normalizacion' },
            'chunking': { id: 'status-chunking', label: 'Chunking' },
            'embeddings': { id: 'status-embeddings', label: 'Embeddings' },
            'indexing': { id: 'status-indexing', label: 'Indexacion' },
            'raptor': { id: 'status-raptor', label: 'RAPTOR' },
            'graph': { id: 'status-graph', label: 'Knowledge Graph' }
          };

          // Actualizar checkboxes seg√∫n el estado
          Object.keys(stepMap).forEach(step => {
            const checkbox = document.getElementById(stepMap[step].id);
            if (checkbox) {
              if (status.step === step && status.status === 'running') {
                checkbox.checked = false;
                checkbox.parentElement.style.color = '#3b82f6'; // azul = en progreso
                console.log(`[Pipeline Polling] ${step}: EN PROGRESO`);
              } else if (status.step === step && status.status === 'completed') {
                checkbox.checked = true;
                checkbox.parentElement.style.color = '#22c55e'; // verde = completado
                console.log(`[Pipeline Polling] ${step}: COMPLETADO`);
              }

              // Marcar completados los pasos anteriores
              const stepOrder = Object.keys(stepMap);
              const currentIndex = stepOrder.indexOf(status.step);
              const thisIndex = stepOrder.indexOf(step);
              if (thisIndex < currentIndex) {
                checkbox.checked = true;
                checkbox.parentElement.style.color = '#22c55e';
              }
            }
          });

          // Si complet√≥ o fall√≥, detener polling
          if (status.completed) {
            document.getElementById('pipeline-status').innerHTML = `[OK] <span style="color: #22c55e;">Completado</span>`;
            showNotification('Pipeline completado exitosamente!', 'success');
            console.log('[Pipeline Polling] Pipeline COMPLETADO');
            Object.values(stepMap).forEach(item => {
              const checkbox = document.getElementById(item.id);
              if (checkbox) {
                checkbox.checked = true;
                checkbox.parentElement.style.color = '#22c55e';
              }
            });
            clearInterval(pipelinePollingInterval);
            pipelinePollingInterval = null;
            loadCorpusInfo();
          } else if (status.failed) {
            document.getElementById('pipeline-status').innerHTML = `[X] <span style="color: #ef4444;">Error: ${status.error}</span>`;
            showNotification(`Pipeline fallo: ${status.error}`, 'error');
            console.error('[Pipeline Polling] Pipeline FALLO:', status.error);
            clearInterval(pipelinePollingInterval);
            pipelinePollingInterval = null;
          } else if (!status.running && status.step === 'none') {
            console.log('[Pipeline Polling] No hay pipeline en ejecucion aun...');
          }

        } catch (error) {
          console.error('[Pipeline Polling] Error consultando estado del pipeline:', error);
        }
      };

      // Primera actualizaci√≥n inmediata
      updateStatus();

      // Polling cada 2 segundos
      pipelinePollingInterval = setInterval(updateStatus, 2000);
      console.log('[Pipeline Polling] Polling iniciado (cada 2 segundos)');
    }

    async function advancedSearch() {
      if (!globalState.backendOnline) {
        showNotification('Backend no disponible', 'error');
        return;
      }

      const query = document.getElementById('corpus-query').value.trim();
      if (!query) {
        showNotification('Escribe una pregunta', 'warning');
        return;
      }

      const mode = document.getElementById('search-mode').value;
      const topK = parseInt(document.getElementById('search-top-k').value);
      const enableRerank = document.getElementById('enable-rerank').checked;
      const enableCrag = document.getElementById('enable-crag').checked;

      try {
        showNotification(`üîç Buscando con modo ${mode}...`, 'info');

        const params = new URLSearchParams({
          q: query,
          mode: mode,
          top_k: topK,
          enable_rerank: enableRerank,
          enable_crag: enableCrag,
          min_score: 0.0
        });

        const response = await fetch(`${API_BASE}/api/corpus/search?${params}`);
        const data = await response.json();

        const resultsDiv = document.getElementById('search-results');

        if (data.success && data.results.length > 0) {
          resultsDiv.innerHTML = `
            <div style="margin-bottom: 15px; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 4px;">
              <strong>Modo:</strong> ${data.mode} | 
              <strong>Resultados:</strong> ${data.total} | 
              <strong>Snapshot:</strong> ${data.snapshot}
              ${data.rerank_enabled ? ' | <span style="color: #22c55e;">‚úÖ Rerank</span>' : ''}
              ${data.crag_enabled ? ' | <span style="color: #22c55e;">‚úÖ CRAG</span>' : ''}
            </div>
            ${data.results.map((r, idx) => `
              <div style="padding: 12px; margin-bottom: 10px; background: rgba(30, 41, 59, 0.6); border-left: 3px solid #3b82f6; border-radius: 4px;">
                <div style="font-weight: bold; color: #3b82f6; margin-bottom: 5px;">
                  #${idx + 1} - ${r.doc_id || r.chunk_id || 'Documento'}
                </div>
                <div style="color: #e2e8f0; margin-bottom: 5px; font-size: 0.9rem;">
                  ${r.text || r.title || 'Sin texto'}
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #64748b;">
                  <span>Score: ${((r.score || 0) * 100).toFixed(1)}%</span>
                  ${r.source ? `<span>Fuente: ${r.source}</span>` : ''}
                </div>
              </div>
            `).join('')}
          `;
          showNotification(`${data.results.length} resultados encontrados`, 'success');
        } else {
          resultsDiv.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">No se encontraron resultados</p>';
          showNotification('No se encontraron resultados', 'warning');
        }
      } catch (error) {
        console.error('Error en b√∫squeda avanzada:', error);
        showNotification('Error en b√∫squeda', 'error');
      }
    }

    async function loadSnapshots() {
      if (!globalState.backendOnline) {
        showNotification('Backend no disponible', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/corpus/snapshots`);
        const data = await response.json();

        const listDiv = document.getElementById('snapshots-list');

        if (data.success && data.snapshots.length > 0) {
          listDiv.innerHTML = `
            <div style="margin-bottom: 10px; color: #94a3b8;">
              <strong>Total:</strong> ${data.total} snapshots | <strong>Latest:</strong> ${data.latest}
            </div>
            ${data.snapshots.map(s => `
              <div style="padding: 10px; margin-bottom: 8px; background: rgba(30, 41, 59, 0.6); border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: bold; color: ${s.is_latest ? '#22c55e' : '#f1f5f9'};">
                    ${s.is_latest ? '‚≠ê ' : ''}${s.name}
                  </div>
                  <div style="font-size: 0.85rem; color: #94a3b8;">
                    üìÖ ${new Date(s.created).toLocaleString('es-ES')} | 
                    üìÑ ${s.documents} docs | 
                    ‚úÇÔ∏è ${s.chunks} chunks
                  </div>
                </div>
                ${!s.is_latest ? `
                  <button class="btn" onclick="activateSnapshot('${s.name}')" 
                          style="padding: 5px 10px; font-size: 0.85rem;">
                    Activar
                  </button>
                ` : ''}
              </div>
            `).join('')}
          `;
          showNotification(`${data.total} snapshots cargados`, 'success');
        } else {
          listDiv.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">No hay snapshots disponibles</p>';
        }
      } catch (error) {
        console.error('Error cargando snapshots:', error);
        showNotification('Error cargando snapshots', 'error');
      }
    }

    async function createSnapshot() {
      if (!globalState.backendOnline) {
        showNotification('Backend no disponible', 'error');
        return;
      }

      const name = prompt('Nombre del snapshot (dejar vac√≠o para auto-generar):');
      if (name === null) return; // Cancelado

      try {
        const formData = new FormData();
        formData.append('name', name || '');

        const response = await fetch(`${API_BASE}/api/corpus/snapshot/create`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          showNotification(`‚úÖ Snapshot creado: ${data.snapshot}`, 'success');
          loadSnapshots();
          loadCorpusInfo();
        } else {
          throw new Error(data.detail || 'Error creando snapshot');
        }
      } catch (error) {
        console.error('Error creando snapshot:', error);
        showNotification('Error creando snapshot', 'error');
      }
    }

    async function activateSnapshot(name) {
      if (!globalState.backendOnline) {
        showNotification('Backend no disponible', 'error');
        return;
      }

      if (!confirm(`¬øActivar snapshot "${name}"?`)) return;

      try {
        const formData = new FormData();
        formData.append('name', name);

        const response = await fetch(`${API_BASE}/api/corpus/snapshot/activate`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          showNotification(`‚úÖ Snapshot activado: ${name}`, 'success');
          loadSnapshots();
          loadCorpusInfo();
        } else {
          throw new Error(data.detail || 'Error activando snapshot');
        }
      } catch (error) {
        console.error('Error activando snapshot:', error);
        showNotification('Error activando snapshot', 'error');
      }
    }

    async function loadCorpusMetrics() {
      if (!globalState.backendOnline) {
        showNotification('Backend no disponible', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/corpus/metrics`);
        const data = await response.json();

        if (data.success) {
          const metrics = data.metrics;

          document.getElementById('rag-service-status').textContent =
            metrics.rag_service_available ? '‚úÖ Disponible' : '‚ùå No disponible';
          document.getElementById('unified-search-status').textContent =
            metrics.unified_search_available ? '‚úÖ Disponible' : '‚ùå No disponible';

          if (metrics.local_files) {
            const total = metrics.local_files.txt + metrics.local_files.pdf + metrics.local_files.md;
            document.getElementById('local-files-count').textContent = total;
          }
        }
      } catch (error) {
        console.error('Error cargando m√©tricas:', error);
        showNotification('Error cargando m√©tricas', 'error');
      }
    }

    async function saveCorpusFeatures() {
      if (!globalState.backendOnline) {
        showNotification('Backend no disponible', 'error');
        return;
      }

      const features = [
        { name: 'rerank', enabled: document.getElementById('feature-rerank').checked },
        { name: 'crag', enabled: document.getElementById('feature-crag').checked },
        { name: 'cache', enabled: document.getElementById('feature-cache').checked }
      ];

      try {
        for (const feature of features) {
          const formData = new FormData();
          formData.append('feature', feature.name);
          formData.append('enabled', feature.enabled);

          await fetch(`${API_BASE}/api/corpus/feature/toggle`, {
            method: 'POST',
            body: formData
          });
        }

        showNotification('‚úÖ Features guardadas correctamente', 'success');
      } catch (error) {
        console.error('Error guardando features:', error);
        showNotification('Error guardando features', 'error');
      }
    }

    async function runDoctor() {
      if (!globalState.backendOnline) {
        showNotification('Backend no disponible', 'error');
        return;
      }

      try {
        showNotification('ü©∫ Ejecutando diagn√≥stico...', 'info');

        const response = await fetch(`${API_BASE}/api/corpus/doctor`, {
          method: 'POST'
        });

        const data = await response.json();

        const outputDiv = document.getElementById('doctor-output');
        outputDiv.style.display = 'block';

        if (data.success) {
          outputDiv.innerHTML = `<div style="color: #22c55e; margin-bottom: 10px;">‚úÖ Diagn√≥stico completado</div>\n${data.output}`;
          showNotification('‚úÖ Diagn√≥stico completado', 'success');
        } else {
          outputDiv.innerHTML = `<div style="color: #ef4444; margin-bottom: 10px;">‚ùå Errores encontrados</div>\n${data.output}\n\n<div style="color: #f59e0b; margin-top: 10px;">ERRORES:</div>\n${data.errors}`;
          showNotification('‚ö†Ô∏è Se encontraron errores', 'warning');
        }
      } catch (error) {
        console.error('Error ejecutando doctor:', error);
        const outputDiv = document.getElementById('doctor-output');
        outputDiv.style.display = 'block';
        outputDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Error: ${error.message}</div>`;
        showNotification('Error ejecutando doctor', 'error');
      }
    }
  </script>
</body>

</html>